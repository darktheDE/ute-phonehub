## **Module 5: Giỏ hàng (Shopping Cart)**

---

### ***Functional Requirements***

| ID | Mô tả yêu cầu chức năng |
| --- | --- |
| **[FR-CART-01]** | Người dùng có thể thêm sản phẩm vào giỏ hàng từ trang danh sách hoặc trang chi tiết sản phẩm. |
| **[FR-CART-02]** | Biểu tượng giỏ hàng (cart icon) trên header phải tự động cập nhật tổng số lượng sản phẩm sau mỗi thao tác thêm, sửa hoặc xóa. |
| **[FR-CART-03]** | Tại trang giỏ hàng, người dùng có thể xem danh sách sản phẩm, chỉnh sửa số lượng hoặc xóa sản phẩm khỏi giỏ. |
| **[FR-CART-04]** | Hệ thống phải tự động tính và hiển thị tổng tiền của giỏ hàng (bao gồm giảm giá, phí ship nếu có). |

---

### **1. Thêm sản phẩm vào giỏ hàng**

(Đáp ứng yêu cầu **[FR-CART-01]**)

| **Mục** | **Nội dung** |
| --- | --- |
| **Actor** | Người dùng (đăng nhập hoặc khách) |
| **Trigger** | Người dùng nhấn **"Thêm vào giỏ hàng"** tại trang danh sách hoặc chi tiết sản phẩm. |
| **Description** | Hệ thống thêm sản phẩm được chọn vào giỏ hàng (lưu trong Redis với key `cart:{userId}` hoặc `cart:{sessionId}`), sau đó trả về giỏ hàng mới gồm danh sách sản phẩm và tổng số lượng. |
| **Pre-Conditions** | - Sản phẩm còn hàng.- Người dùng đang duyệt trang sản phẩm. |
| **Post-Conditions** | - Sản phẩm được thêm thành công vào giỏ hàng.- Biểu tượng giỏ hàng được cập nhật tổng số lượng mới. |
| **Main Flow** | 1️⃣ Người dùng nhấn nút “Thêm vào giỏ hàng”.                                     2️⃣ Frontend gửi request `POST /api/v1/cart/items` kèm `{ productId, quantity }`.                   3️⃣ Backend lấy `userId` từ JWT hoặc session.                                      4️⃣ Hệ thống kiểm tra tồn kho và thông tin sản phẩm.                          5️⃣ Thêm sản phẩm vào Redis (key: `cart:{userId}`).                                6️⃣ Backend trả về giỏ hàng mới (`data`: danh sách sản phẩm, tổng tiền, tổng số lượng).                          7️⃣ Frontend cập nhật biểu tượng giỏ hàng và hiển thị thông báo “Đã thêm vào giỏ hàng!”. |
| **Alternate Flow** | - **AF-1:** Sản phẩm hết hàng → Trả lỗi `400` với thông báo “Sản phẩm tạm hết hàng”.                                              - **AF-2:** Redis lỗi → Dữ liệu được lưu tạm vào `localStorage` hoặc session phía frontend.   |

---

### **2. Cập nhật số lượng / Xóa sản phẩm trong giỏ hàng**

(Đáp ứng yêu cầu **[FR-CART-03]**)

| **Mục** | **Nội dung** |
| --- | --- |
| **Actor** | Người dùng |
| **Trigger** | Người dùng thao tác **tăng/giảm số lượng** hoặc **xóa sản phẩm** tại trang giỏ hàng. |
| **Description** | Cho phép người dùng thay đổi số lượng hoặc xóa sản phẩm khỏi giỏ hàng. Redis sẽ được cập nhật và frontend hiển thị lại đúng dữ liệu. |
| **Pre-Conditions** | - Giỏ hàng phải có ít nhất một sản phẩm.- Người dùng đã được xác định (qua JWT hoặc session). |
| **Post-Conditions** | - Giỏ hàng được cập nhật thành công trên Redis.- Giao diện giỏ hàng hiển thị dữ liệu mới và tổng tiền được tính lại. |
| **Main Flow (Cập nhật số lượng)** | 1️⃣ Người dùng thay đổi số lượng sản phẩm.                                            2️⃣ Frontend gửi request `PUT /api/v1/cart/items/{productId}` với `{ quantity }`.                             3️⃣ Backend kiểm tra tồn kho và tính hợp lệ của số lượng.                 4️⃣ Redis được cập nhật theo userId.5️⃣ Backend trả về giỏ hàng mới.     6️⃣ Frontend hiển thị thông tin và tổng tiền mới. |
| **Main Flow (Xóa sản phẩm)** | 1️⃣ Người dùng nhấn nút “Xóa”.     2️⃣ Frontend gửi request `DELETE /api/v1/cart/items/{productId}`. 3️⃣ Backend xóa sản phẩm khỏi Redis.                                                    4️⃣ Backend trả về giỏ hàng mới (sau khi xóa).                                       5️⃣ Frontend cập nhật giao diện. |
| **Alternate Flow** | - **AF-1:** Nhập số lượng vượt quá tồn kho → Thông báo lỗi “Số lượng vượt quá hàng tồn”.                             - **AF-2:** Xóa toàn bộ sản phẩm → Hiển thị thông báo “Chưa có sản phẩm nào trong giỏ hàng”. |

---

### **3. Cập nhật biểu tượng giỏ hàng (Cart Icon)**

(Đáp ứng yêu cầu **[FR-CART-02]**)

| **Mục** | **Nội dung** |
| --- | --- |
| **Actor** | Người dùng |
| **Trigger** | Có thay đổi trong giỏ hàng (thêm, cập nhật, xóa). |
| **Description** | Biểu tượng giỏ hàng trên header hiển thị tổng số sản phẩm hiện có trong giỏ. Dữ liệu được cập nhật theo kết quả trả về từ API. |
| **Pre-Conditions** | Giỏ hàng tồn tại (trong Redis hoặc session). |
| **Post-Conditions** | Biểu tượng giỏ hàng được cập nhật đúng số lượng hiện tại. |
| **Main Flow** | 1️⃣ Sau mỗi thao tác thêm/xóa/cập nhật, backend trả về tổng số lượng mới.                                                       2️⃣ Frontend nhận dữ liệu từ API `/api/v1/cart` hoặc response trả về sau thao tác.                                  3️⃣ Biểu tượng giỏ hàng (`badge`) được cập nhật lại.                              4️⃣ Hiển thị animation hoặc tooltip “Cập nhật giỏ hàng thành công”. |
| **Alternate Flow** | - **AF-1:** Mất kết nối mạng → Icon không cập nhật ngay, cập nhật lại khi reload trang.                                   - **AF-2:** API trả lỗi → Giữ nguyên số lượng cũ, log lỗi vào console hoặc Sentry. |

---

### **4. Tính tổng tiền giỏ hàng**

(Đáp ứng yêu cầu **[FR-CART-04]**)

| **Mục** | **Nội dung** |
| --- | --- |
| **Actor** | Người dùng |
| **Trigger** | Người dùng truy cập trang giỏ hàng hoặc thay đổi số lượng/xóa sản phẩm. |
| **Description** | Hệ thống tự động tính tổng tiền giỏ hàng dựa trên **đơn giá × số lượng** của từng sản phẩm, áp dụng giảm giá (nếu có) và hiển thị kết quả. |
| **Pre-Conditions** | - Giỏ hàng có ít nhất một sản phẩm hợp lệ.- Dữ liệu giỏ hàng lấy được từ Redis. |
| **Post-Conditions** | - Tổng tiền được tính chính xác và hiển thị cho người dùng. |
| **Main Flow** | 1️⃣ Backend truy xuất danh sách sản phẩm từ Redis (`cart:{userId}`).2️⃣ Tính tổng tiền: **Tổng tạm tính = Σ(giá × số lượng)**.                             3️⃣ Áp dụng mã giảm giá hoặc phí vận chuyển (nếu có).                         4️⃣ Backend trả về giá trị tổng cộng.5️⃣ Frontend hiển thị các phần: “Tạm tính”, “Giảm giá”, “Thành tiền”.6️⃣ Khi người dùng thay đổi số lượng → API `PUT /api/v1/cart/items/{productId}` được gọi → hệ thống tự động cập nhật lại tổng tiền. |
| **Alternate Flow** | - **AF-1:** Có sản phẩm không hợp lệ (giá null, hết hàng) → Loại khỏi phép tính và hiển thị cảnh báo “Một số sản phẩm không còn khả dụng”. - **AF-2:** Redis timeout → Thông báo “Không thể tải giỏ hàng, vui lòng thử lại” và cho phép reload lại. |