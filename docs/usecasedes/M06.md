**Actors**

- Registered Customer (Khách hàng đã đăng ký)
- Payment Gateway (Cổng thanh toán VNPay/MoMo)
- Administrator (Quản trị viên)

**Use cases**

Registered Customer:

- **Thanh toán đơn hàng online**
- **Xem lịch sử thanh toán**

Payment Gateway (VNPay/MoMo)

Administrator:

- Xem & quản lý giao dịch thanh toán
- Cấu hình thông tin cổng thanh toán

## Mô tả chi tiết từng Use Case

1. **Thanh toán hàng online**

| **Mục** | **Nội dung** |
| --- | --- |
| Use case | **Thanh toán đơn hàng online** |
| Actor | Registered Customer |
| Trigger | Actor chọn phương thức **“Thanh toán online (VNPay/MoMo)”** và bấm nút **“Thanh toán”** trên màn hình checkout. |
| Description | Use case này cho phép Actor thanh toán đơn hàng bằng cổng VNPay hoặc MoMo. Hệ thống tạo yêu cầu thanh toán, chuyển hướng Actor sang VNPay/MoMo, nhận kết quả trả về và cập nhật trạng thái đơn hàng/giao dịch. |
| Pre-Conditions | - Actor đã đăng nhập hệ thống.- Đơn hàng đã được tạo, trạng thái **“Chờ thanh toán”**.- Cổng thanh toán (VNPay/MoMo) đã được cấu hình và đang active. |
| Post-Conditions | - Nếu thanh toán **thành công**: tạo bản ghi Payment trạng thái **“THÀNH CÔNG”**, Order chuyển sang **“Đã thanh toán/Đang xử lý”**.- Nếu thanh toán **thất bại/hủy**: Payment ở trạng thái **“THẤT BẠI/HỦY”**, Order vẫn **“Chờ thanh toán”**. |
| Main Flow | 1. Actor kiểm tra thông tin đơn hàng trên màn hình checkout.
2. Actor chọn phương thức “VNPay” hoặc “MoMo” và bấm **“Thanh toán”**.
3. Hệ thống kiểm tra điều kiện đơn hàng (tổng tiền > 0, chưa thanh toán, còn hàng…).
4. Hệ thống **gọi use case “Tạo yêu cầu thanh toán tới cổng VNPay/MoMo”** để sinh URL thanh toán.
5. Hệ thống lưu bản ghi Payment trạng thái **“ĐANG XỬ LÝ”**.
6. Hệ thống redirect Actor sang trang thanh toán VNPay/MoMo.
7. Actor thao tác thanh toán trên VNPay/MoMo.
8. Sau khi thanh toán, cổng gọi callback → hệ thống **gọi use case “Xử lý callback kết quả thanh toán”**.
9. Hệ thống hiển thị màn hình kết quả (thành công/thất bại) cho Actor. |
| Alternate Flow | - Actor hủy thanh toán hoặc thoát khỏi trang VNPay/MoMo → Payment cập nhật **“HỦY”**, Order vẫn **“Chờ thanh toán”**, cho phép thanh toán lại. |
| Exception Flow | - Không kết nối được tới VNPay/MoMo hoặc lỗi tạo request → hệ thống báo “Không thể thực hiện thanh toán online, vui lòng thử lại sau hoặc chọn phương thức khác”, Order giữ nguyên. |
1. **Tạo yêu cầu thanh toán tới cổng VNPay/MoMo**

| **Mục** | **Nội dung** |  |
| --- | --- | --- |
| Use case | **Tạo yêu cầu thanh toán tới cổng VNPay/MoMo** |  |
| Actor | Registered Customer (gián tiếp, thông qua UC 1) |  |
| Trigger | Được **extend/gọi** từ use case “Thanh toán đơn hàng online” khi Actor bấm nút **“Thanh toán”**. |  |
| Description | Use case này tạo request hợp lệ gửi tới VNPay/MoMo: gom dữ liệu đơn hàng, tính chữ ký (signature), sinh URL thanh toán và lưu bản ghi Payment tương ứng. |  |
| Pre-Conditions | - Order tồn tại, trạng thái **“Chờ thanh toán”**.- Thông tin cấu hình cổng thanh toán (merchantCode, secretKey, returnUrl, callbackUrl,…) đã được lưu và còn hiệu lực. |  |
| Post-Conditions | - Tạo mới bản ghi Payment với số tiền, phương thức, mã đơn hàng, trạng thái **“ĐANG XỬ LÝ”**.- Sinh được URL thanh toán hợp lệ để redirect Actor sang VNPay/MoMo. |  |
| Main Flow | 1. Hệ thống lấy thông tin Order (mã đơn, số tiền, mô tả, khách hàng).
2. Hệ thống đọc cấu hình tương ứng với cổng đã chọn (VNPay/MoMo).
3. Hệ thống build bộ tham số request theo tài liệu của cổng thanh toán.
4. Hệ thống tạo chữ ký bảo mật (signature) bằng secretKey.
5. Hệ thống lưu bản ghi Payment trạng thái **“ĐANG XỬ LÝ”**.
6. Hệ thống ghép tham số thành URL thanh toán và trả về cho use case “Thanh toán đơn hàng online”. |  |
| Alternate Flow | Không có. |  |
| Exception Flow | - Thiếu/không hợp lệ merchantCode, secretKey hoặc cấu hình bị disable → hệ thống báo lỗi, không tạo Payment, thông báo “Phương thức thanh toán tạm thời không khả dụng”. |  |
1. **Xử lý callback kết quả thanh toán**

| **Mục** | **Nội dung** |
| --- | --- |
| Use case | **Xử lý callback kết quả thanh toán** |
| Actor | Payment Gateway (VNPay/MoMo) |
| Trigger | Sau khi khách thanh toán, VNPay/MoMo gửi HTTP callback đến URL webhook của hệ thống. |
| Description | Use case này nhận dữ liệu callback, kiểm tra chữ ký, đọc trạng thái giao dịch, ghi log và cập nhật Payment/Order tương ứng. |
| Pre-Conditions | - Tồn tại bản ghi Payment tương ứng với mã giao dịch/mã đơn hàng VNPay/MoMo gửi về.- URL callback đã được đăng ký với cổng thanh toán. |
| Post-Conditions | - Payment được cập nhật đúng trạng thái (**THÀNH CÔNG/THẤT BẠI/HỦY**).- Order cập nhật tương ứng (Đã thanh toán / vẫn Chờ thanh toán).- Lưu log callback phục vụ đối soát. |
| Main Flow | 1. Hệ thống nhận request callback từ VNPay/MoMo (orderId, amount, responseCode, signature,…).
2. Hệ thống kiểm tra chữ ký (signature) bằng secretKey.
3. Hệ thống tìm bản ghi Payment tương ứng.
4. Nếu responseCode **thành công**:  
   4.1. Cập nhật Payment → **“THÀNH CÔNG”**, lưu thời gian thanh toán.   
   4.2. Cập nhật Order → **“Đã thanh toán/Đang xử lý”**.
5. Nếu responseCode **thất bại/hủy**:
   5.1. Cập nhật Payment → **“THẤT BẠI”/“HỦY”**.
   5.2. Order giữ nguyên **“Chờ thanh toán”**.
6. Hệ thống lưu bản ghi PaymentCallbackLog (rawData, status, thời gian nhận).
7. Hệ thống trả về thông báo cho VNPay/MoMo (ví dụ: “OK”). |
| Alternate Flow | Không có. |
| Exception Flow | - Chữ ký không hợp lệ → từ chối callback, ghi log “Invalid signature”, không cập nhật Payment/Order.- Không tìm thấy Payment tương ứng → ghi log “Payment not found”, không cập nhật Order. |
1. **Xem & quản lý giao dịch thanh toán**

| **Mục** | **Nội dung** |
| --- | --- |
| Use case | **Xem & quản lý giao dịch thanh toán** |
| Actor | Administrator |
| Trigger | Actor mở chức năng **“Quản lý thanh toán / Danh sách giao dịch”** trong trang quản trị. |
| Description | Use case này cho phép Administrator xem danh sách Payment, lọc theo trạng thái – phương thức – thời gian, xem chi tiết giao dịch và cập nhật ghi chú/đánh dấu đối soát. |
| Pre-Conditions | - Administrator đã đăng nhập và có quyền quản lý thanh toán. |
| Post-Conditions | - Administrator xem được chi tiết các giao dịch và lưu lại ghi chú, cờ “đã đối soát” nếu có. |
| Main Flow | 1. Actor mở màn hình “Quản lý thanh toán”.
2. Hệ thống hiển thị danh sách Payment (mã giao dịch, mã đơn hàng, khách hàng, số tiền, cổng thanh toán, trạng thái,…).
3. Actor nhập điều kiện tìm kiếm (trạng thái, khoảng thời gian, phương thức…).
4. Hệ thống lọc và hiển thị danh sách phù hợp.
5. Actor chọn một giao dịch để xem chi tiết (Order liên quan, log callback, mã giao dịch phía VNPay/MoMo…).
6. Actor cập nhật ghi chú, đánh dấu “Đã đối soát” (nếu cần) và lưu.
7. Hệ thống lưu thay đổi và cập nhật giao diện. |
| Alternate Flow | Không có. |
| Exception Flow | - Actor không có quyền → hệ thống báo “Không có quyền truy cập chức năng này”. |