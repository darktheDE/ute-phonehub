1. **Tổng quan đồ án**

UTE Phone Hub là một **website thương mại điện tử** chuyên kinh doanh điện thoại và phụ kiện, được xây dựng với stack công nghệ hiện đại (Spring Boot backend, Next.js frontend) nhằm mang lại trải nghiệm mua sắm tốt nhất cho khách hàng và công cụ quản lý hiệu quả cho admin.

1. **Công nghệ**
- **Backend:** Java 17, Spring Boot 3+, Spring Security, Spring Data JPA, Hibernate, PostgreSQL, Redis, JWT, Google OAuth2, Maven.
- **Frontend:** Next.js (React), JavaScript ES6+, TailwindCSS, Shadcn/UI.
- **Hạ tầng:** Docker, Tomcat.
1. **API Backend**
- POST /api/v1/auth/register: Đăng ký tài khoản mới.
- POST /api/v1/auth/login: Đăng nhập bằng email/password hoặc Google OAuth2.
- POST /api/v1/auth/refresh: Làm mới access token bằng refresh token.
- POST /api/v1/auth/logout: Đăng xuất, vô hiệu hóa token.
- POST /api/v1/auth/forgot-password/request: Gửi yêu cầu reset mật khẩu (OTP qua email).
- POST /api/v1/auth/forgot-password/verify: Xác thực OTP.
- POST /api/v1/auth/forgot-password/reset: Reset mật khẩu mới.
- POST /api/v1/auth/verify-email: Xác thực email người dùng.
- GET /api/v1/user/me: Lấy thông tin người dùng hiện tại.
- POST /api/v1/user/profile: Cập nhật thông tin cá nhân.
- POST /api/v1/user/password: Đổi mật khẩu.
- GET /api/v1/user/addresses: Lấy danh sách địa chỉ giao hàng.
- POST /api/v1/user/addresses: Thêm địa chỉ mới.
- PUT /api/v1/user/addresses/{id}: Cập nhật địa chỉ.
- DELETE /api/v1/user/addresses/{id}: Xóa địa chỉ.
1. **Database**
- **users:** Lưu trữ thông tin người dùng (email, password hash, username, role, status, v.v.).
- **addresses:** Lưu trữ các địa chỉ giao hàng của người dùng.
- **password_reset_tokens:** Lưu trữ các token dùng cho việc reset mật khẩu, kèm theo thời gian hết hạn. (Có thể thay thế dùng lưu trữ Redis)
1. **Frontend**
- **Trang Đăng ký (Register Page):** Form nhập liệu cho người dùng mới.
- **Trang Đăng nhập (Login Page):** Form đăng nhập, nút "Đăng nhập bằng Google", nút "Quên mật khẩu".
- **Trang Quên mật khẩu (Forgot Password Page):** Form nhập email, form nhập OTP, form nhập mật khẩu mới.
- **Trang Hồ sơ cá nhân (User Profile Page):** Hiển thị và cho phép cập nhật thông tin cá nhân.
- **Trang Quản lý Địa chỉ (Manage Addresses Page):** Danh sách địa chỉ, form thêm/sửa địa chỉ.
1. **SRS**

Chịu trách nhiệm chung toàn bộ SRS.

Toàn bộ phần **"5.1 Đối với Khách hàng"** trong mục **"Yêu cầu Chức năng"** của SRS bao gồm:

- **Tài khoản:** đăng ký, đăng nhập, đăng nhập Google OAuth2, quên mật khẩu (OTP), xác thực email, đổi mật khẩu, cập nhật hồ sơ, quản lý địa chỉ.

**Use Case Description** cho các chức năng này, bao gồm:

- **Use Case:** Đăng ký tài khoản, Đăng nhập, Quên mật khẩu, Cập nhật thông tin cá nhân, Quản lý địa chỉ.
- Mỗi Use Case sẽ có các phần: Actor, Trigger, Description, Pre-Conditions, Post-Conditions, Main Flow, Alternate Flow, Exception Flow.
1. **Diagram**
- **Use Case Diagram:** vẽ các use case liên quan đến xác thực và quản lý tài khoản, ví dụ: "Đăng ký", "Đăng nhập", "Quên mật khẩu", "Cập nhật thông tin cá nhân".
- **Sequence Diagrams:** vẽ 1-2 sequence diagram cho các luồng quan trọng trong module của mình, ví dụ:
    - Luồng "Đăng ký tài khoản" (từ Frontend gọi API Register, Backend xử lý, lưu DB, gửi email xác thực).
    - Luồng "Đăng nhập bằng Google OAuth2" (Frontend gọi Google, nhận token, gửi lên Backend để xác thực và tạo JWT).
- **Activity Diagram:** Có thể vẽ cho quy trình "Quên mật khẩu" hoặc "Cập nhật thông tin cá nhân" để làm rõ các bước và điều kiện.
1. **Đặt tả Use Case**

**UC-M01-01: Đăng ký Tài khoản**

| Thuộc tính | Mô tả |
| --- | --- |
| **Tên Use Case** | Đăng ký Tài khoản Khách hàng |
| **Actor** | Khách hàng (Chưa có tài khoản) |
| **Trigger** | Khách hàng truy cập website và chọn chức năng "Đăng ký". |
| **Mô tả** | Use case này cho phép khách hàng mới tạo một tài khoản trên hệ thống UTE Phone Hub bằng cách cung cấp thông tin cá nhân cần thiết. |
| **Điều kiện Tiên quyết** | - Khách hàng chưa có tài khoản trên hệ thống.
- Email cần đăng ký phải hợp lệ và chưa từng được sử dụng để đăng ký. |
| **Kết quả Sau cùng** | - Tài khoản khách hàng được tạo thành công trong cơ sở dữ liệu với trạng thái "Chưa xác thực email".
- Khách hàng nhận được email chứa liên kết/token xác thực.
- Khách hàng được điều hướng đến trang thông báo chờ xác thực. |
| **Luồng Sự kiện Chính** | 1. Khách hàng chọn nút "Đăng nhập" trên thanh navbar giao diện chính.
2. Tại giao diện đăng nhập, chọn đăng ký. Hệ thống hiển thị trang Đăng ký với các trường thông tin.
3. Khách hàng nhập các thông tin bắt buộc: Họ tên, Email, Mật khẩu, Nhập lại mật khẩu.
5. Khách hàng nhấn nút "Đăng ký".
6. Hệ thống (Frontend) gửi yêu cầu đăng ký đến API Backend.
7. Hệ thống (Backend) thực hiện xác thực đầu vào:
 a. Kiểm tra định dạng Email.
 b. Kiểm tra độ mạnh của Mật khẩu.
 c. Kiểm tra Mật khẩu và Nhập lại mật khẩu có khớp nhau không.
 d. Kiểm tra xem Email đã tồn tại trong hệ thống chưa.
8. Nếu tất cả các bước xác thực đều thành công:
 a. Hệ thống tạo một tài khoản người dùng mới với trạng thái "Chưa xác thực email".
 b. Mã hóa mật khẩu bằng BCrypt và lưu vào cơ sở dữ liệu.
 c. Tạo một token xác thực email duy nhất, lưu vào DB kèm thời gian hết hạn.
 d. Gửi một email chứa liên kết xác thực đến địa chỉ email của khách hàng.
 e. Trả về thông báo thành công cho Frontend.
9. Hệ thống (Frontend) hiển thị thông báo thành công và hướng dẫn khách hàng kiểm tra hộp thư để xác thực tài khoản. |
| **Luồng Lỗi** | **7a, 7b, 7c. Dữ liệu không hợp lệ:** Hệ thống (Backend) trả về lỗi 400 (Bad Request) với thông báo chi tiết. Frontend hiển thị thông báo lỗi tương ứng tại trường nhập liệu.
**7d. Email đã tồn tại:** Hệ thống (Backend) trả về lỗi 409 (Conflict). Frontend hiển thị thông báo "Email này đã được sử dụng" và gợi ý đăng nhập hoặc quên mật khẩu.
**8d. Lỗi gửi email:** Hệ thống ghi nhận lỗi, nhưng vẫn tạo tài khoản. Frontend hiển thị thông báo đăng ký thành công nhưng có lỗi khi gửi email, và cung cấp tùy chọn "Gửi lại email xác thực". |

**UC-M01-02: Đăng nhập bằng Email và Mật khẩu**

| Thuộc tính | Mô tả |
| --- | --- |
| **Tên Use Case** | Đăng nhập bằng Email và Mật khẩu |
| **Actor** | Khách hàng (Đã có tài khoản) |
| **Trigger** | Khách hàng truy cập trang Đăng nhập và điền thông tin. |
| **Mô tả** | Cho phép khách hàng đã đăng ký truy cập vào tài khoản của mình bằng email và mật khẩu. |
| **Điều kiện Tiên quyết** | Khách hàng đã có tài khoản và đã xác thực email. |
| **Kết quả Sau cùng** | - Khách hàng đăng nhập thành công.
- Hệ thống tạo và trả về cặp JWT (Access Token & Refresh Token).
- Frontend lưu trữ token và điều hướng khách hàng đến trang chủ hoặc trang trước đó. |
| **Luồng Sự kiện Chính** | 1. Khách hàng truy cập trang Đăng nhập.
2. Khách hàng nhập Email và Mật khẩu.
3. Khách hàng nhấn nút "Đăng nhập".
4. Hệ thống (Frontend) gửi thông tin đăng nhập đến API Backend.
5. Hệ thống (Backend) tìm người dùng bằng email.
6. So sánh mật khẩu đã nhập với mật khẩu đã băm trong DB bằng BCrypt.
7. Nếu mật khẩu khớp, hệ thống kiểm tra trạng thái tài khoản (không bị khóa, đã xác thực email).
8. Hệ thống tạo một Access Token (thời hạn ngắn, ví dụ: 24 giờ) và một Refresh Token (thời hạn dài, ví dụ: 7 ngày).
9. Lưu Refresh Token vào Redis để quản lý.
10. Trả về cặp token và thông tin cơ bản của người dùng cho Frontend.
11. Hệ thống (Frontend) lưu trữ token (ví dụ: Access Token trong memory, Refresh Token trong HttpOnly cookie) và cập nhật trạng thái đăng nhập trên UI.
12. Điều hướng khách hàng đến trang chủ. |
| **Luồng Lỗi** | **5. Không tìm thấy email:** Hệ thống trả về lỗi 401 (Unauthorized) với thông báo "Email hoặc mật khẩu không chính xác".
**6. Mật khẩu không khớp:** Hệ thống trả về lỗi 401 (Unauthorized) với thông báo "Email hoặc mật khẩu không chính xác".
**7. Tài khoản bị khóa:** Hệ thống trả về lỗi 403 (Forbidden) với thông báo "Tài khoản của bạn đã bị khóa".
**7. Email chưa xác thực:** Hệ thống trả về lỗi 403 (Forbidden) với thông báo "Vui lòng xác thực email của bạn" và cung cấp tùy chọn gửi lại email xác thực. |

**UC-M01-03: Đăng nhập bằng Google (OAuth2)**

| Thuộc tính | Mô tả |
| --- | --- |
| **Tên Use Case** | Đăng nhập bằng Google |
| **Actor** | Khách hàng |
| **Trigger** | Khách hàng chọn nút "Đăng nhập bằng Google" trên trang Đăng nhập/Đăng ký. |
| **Mô tả** | Cho phép khách hàng đăng nhập hoặc đăng ký nhanh chóng bằng tài khoản Google của họ. |
| **Điều kiện Tiên quyết** | Khách hàng có một tài khoản Google đang hoạt động. |
| **Kết quả Sau cùng** | - Khách hàng đăng nhập thành công.
- Nếu là người dùng mới, một tài khoản mới sẽ được tự động tạo và xác thực.
- Hệ thống tạo và trả về cặp JWT. |
| **Luồng Sự kiện Chính** | 1. Khách hàng nhấn nút "Đăng nhập bằng Google".
2. Hệ thống (Frontend) mở cửa sổ popup/redirect đến trang xác thực của Google.
3. Khách hàng đăng nhập vào tài khoản Google và đồng ý cấp quyền cho ứng dụng.
4. Google trả về một mã ủy quyền (authorization code) cho Frontend.
5. Hệ thống (Frontend) gửi mã ủy quyền này đến API Backend.
6. Hệ thống (Backend) dùng mã ủy quyền để trao đổi với Google và nhận về thông tin người dùng (email, họ tên, ảnh đại diện).
7. Hệ thống (Backend) kiểm tra xem email nhận được từ Google đã tồn tại trong DB hay chưa.
 a. **Nếu đã tồn tại:** Tiến hành đăng nhập cho người dùng đó (chuyển đến bước 8 của UC-M01-02).
 b. **Nếu chưa tồn tại:** Tự động tạo một tài khoản mới với thông tin từ Google, đặt trạng thái là "Đã xác thực email", và tiến hành đăng nhập (chuyển đến bước 8 của UC-M01-02).
8. Hệ thống (Backend) trả về cặp JWT và thông tin người dùng cho Frontend.
9. Hệ thống (Frontend) lưu trữ token và điều hướng khách hàng đến trang chủ. |
| **Luồng Lỗi** | **3. Khách hàng từ chối cấp quyền:** Cửa sổ của Google đóng lại, không có hành động nào xảy ra.
**6. Lỗi giao tiếp với Google:** Hệ thống (Backend) trả về lỗi 500 (Internal Server Error). Frontend hiển thị thông báo "Đã có lỗi xảy ra với việc đăng nhập Google, vui lòng thử lại". |

**UC-M01-04: Đăng xuất**

| Thuộc tính | Mô tả |
| --- | --- |
| **Tên Use Case** | Đăng xuất |
| **Actor** | Khách hàng (Đã đăng nhập) |
| **Trigger** | Khách hàng chọn chức năng "Đăng xuất" trên giao diện. |
| **Mô tả** | Cho phép khách hàng kết thúc phiên làm việc và đăng xuất an toàn khỏi hệ thống. |
| **Điều kiện Tiên quyết** | Khách hàng đang trong một phiên đăng nhập hợp lệ. |
| **Kết quả Sau cùng** | - Phiên làm việc của khách hàng kết thúc.
- Refresh Token bị vô hiệu hóa.
- Frontend xóa bỏ các token đã lưu và cập nhật UI về trạng thái chưa đăng nhập. |
| **Luồng Sự kiện Chính** | 1. Khách hàng nhấn vào nút "Đăng xuất".
2. Hệ thống (Frontend) gửi yêu cầu đăng xuất đến API Backend, kèm theo Refresh Token.
3. Hệ thống (Backend) nhận Refresh Token và xóa nó khỏi Redis.
4. Hệ thống (Backend) trả về thông báo đăng xuất thành công.
5. Hệ thống (Frontend) xóa Access Token và Refresh Token khỏi bộ nhớ/cookie.
6. Cập nhật giao diện về trạng thái chưa đăng nhập và điều hướng về trang chủ. |

**UC-M01-05: Quên Mật khẩu**

| Thuộc tính | Mô tả |
| --- | --- |
| **Tên Use Case** | Quên Mật khẩu |
| **Actor** | Khách hàng |
| **Trigger** | Khách hàng chọn liên kết "Quên mật khẩu" trên trang Đăng nhập. |
| **Mô tả** | Cung cấp một quy trình an toàn để khách hàng có thể đặt lại mật khẩu của mình thông qua email. |
| **Điều kiện Tiên quyết** | Khách hàng phải nhớ địa chỉ email đã dùng để đăng ký tài khoản. |
| **Kết quả Sau cùng** | Mật khẩu của khách hàng được cập nhật thành công. |
| **Luồng Sự kiện Chính** | **Giai đoạn 1: Yêu cầu đặt lại mật khẩu**
1. Khách hàng nhấn "Quên mật khẩu".
2. Hệ thống hiển thị trang yêu cầu nhập email.
3. Khách hàng nhập email và nhấn "Gửi".
4. Hệ thống (Backend) kiểm tra email có tồn tại trong DB không.
5. Nếu có, hệ thống tạo một mã OTP (ví dụ: 6 chữ số), lưu vào Redis kèm email và thời gian hết hạn (ví dụ: 5 phút).
6. Hệ thống gửi email chứa mã OTP đến cho khách hàng.
7. Hệ thống (Frontend) điều hướng đến trang nhập OTP.
**Giai đoạn 2: Xác thực OTP và Đặt lại mật khẩu**
8. Khách hàng nhập mã OTP nhận được từ email.
9. Khách hàng nhập Mật khẩu mới và Nhập lại mật khẩu mới.
10. Khách hàng nhấn "Xác nhận".
11. Hệ thống (Backend) xác thực OTP (so sánh với giá trị trong Redis, kiểm tra chưa hết hạn).
12. Nếu OTP hợp lệ, hệ thống xác thực mật khẩu mới (độ mạnh, khớp nhau).
13. Hệ thống băm mật khẩu mới bằng BCrypt và cập nhật vào DB cho người dùng tương ứng.
14. Xóa OTP khỏi Redis.
15. Hệ thống (Frontend) hiển thị thông báo thành công và điều hướng đến trang Đăng nhập. |
| **Luồng Lỗi** | **4. Email không tồn tại:** Hệ thống vẫn hiển thị thông báo "Nếu email tồn tại, một mã OTP sẽ được gửi đi" để tránh việc dò email.
**11. OTP không chính xác hoặc hết hạn:** Hệ thống trả về lỗi. Frontend hiển thị thông báo "Mã OTP không hợp lệ hoặc đã hết hạn" và cung cấp tùy chọn gửi lại OTP.
**12. Mật khẩu mới không hợp lệ:** Frontend hiển thị thông báo lỗi tương ứng. |

**UC-M01-06: Cập nhật Thông tin cá nhân**

| Thuộc tính | Mô tả |
| --- | --- |
| **Tên Use Case** | Cập nhật Thông tin cá nhân |
| **Actor** | Khách hàng (Đã đăng nhập) |
| **Trigger** | Khách hàng truy cập trang "Tài khoản của tôi" và chọn chỉnh sửa thông tin. |
| **Mô tả** | Cho phép khách hàng xem và cập nhật các thông tin cá nhân của mình như Họ tên, Số điện thoại. |
| **Điều kiện Tiên quyết** | Khách hàng đã đăng nhập. |
| **Kết quả Sau cùng** | Thông tin cá nhân của khách hàng được cập nhật thành công trong cơ sở dữ liệu. |
| **Luồng Sự kiện Chính** | 1. Khách hàng điều hướng đến trang "Hồ sơ cá nhân".
2. Hệ thống hiển thị thông tin hiện tại của khách hàng.
3. Khách hàng nhấn nút "Chỉnh sửa".
4. Khách hàng thay đổi các thông tin (ví dụ: Họ tên, Số điện thoại) và nhấn "Lưu thay đổi".
5. Hệ thống (Frontend) gửi yêu cầu cập nhật đến API Backend, kèm theo JWT trong header Authorization.
6. Hệ thống (Backend) xác thực JWT, lấy thông tin người dùng từ token.
7. Cập nhật thông tin mới vào bảng users trong DB.
8. Trả về thông tin người dùng đã được cập nhật.
9. Hệ thống (Frontend) hiển thị thông báo thành công và cập nhật lại thông tin trên giao diện. |

**UC-M01-07: Quản lý Địa chỉ Giao hàng**

| Thuộc tính | Mô tả |
| --- | --- |
| **Tên Use Case** | Quản lý Địa chỉ Giao hàng |
| **Actor** | Khách hàng (Đã đăng nhập) |
| **Trigger** | Khách hàng truy cập trang "Sổ địa chỉ" trong phần tài khoản. |
| **Mô tả** | Cho phép khách hàng thêm, xem, sửa, xóa các địa chỉ giao hàng và đặt một địa chỉ làm mặc định. |
| **Điều kiện Tiên quyết** | Khách hàng đã đăng nhập. |
| **Kết quả Sau cùng** | Danh sách địa chỉ của khách hàng được cập nhật trong cơ sở dữ liệu. |
| **Luồng Sự kiện Chính** | 1. Khách hàng truy cập trang "Sổ địa chỉ".
2. Hệ thống hiển thị danh sách các địa chỉ đã lưu của khách hàng.
**Luồng A: Thêm địa chỉ mới**
 A1. Khách hàng nhấn "Thêm địa chỉ mới".
 A2. Hệ thống hiển thị form nhập thông tin địa chỉ (Họ tên người nhận, SĐT, Tỉnh/Thành, Phường/Xã, địa chỉ cụ thể).
 A3. Khách hàng điền thông tin và nhấn "Lưu".
 A4. Hệ thống (Backend) lưu địa chỉ mới vào bảng addresses và liên kết với người dùng.
 A5. Giao diện được cập nhật với địa chỉ mới.
**Luồng B: Sửa địa chỉ**
 B1. Khách hàng chọn "Sửa" trên một địa chỉ đã có.
 B2. Hệ thống hiển thị form với thông tin cũ, cho phép khách hàng chỉnh sửa.
 B3. Khách hàng nhấn "Lưu".
 B4. Hệ thống (Backend) cập nhật thông tin địa chỉ.
**Luồng C: Xóa địa chỉ**
 C1. Khách hàng chọn "Xóa" trên một địa chỉ.
 C2. Hệ thống hiển thị hộp thoại xác nhận.
 C3. Khách hàng xác nhận xóa.
 C4. Hệ thống (Backend) xóa địa chỉ khỏi DB.
**Luồng D: Đặt làm mặc định**
 D1. Khách hàng chọn "Đặt làm mặc định" trên một địa chỉ không phải là mặc định.
 D2. Hệ thống (Backend) cập nhật trạng thái mặc định cho địa chỉ này và bỏ trạng thái mặc định của địa chỉ cũ (nếu có). |