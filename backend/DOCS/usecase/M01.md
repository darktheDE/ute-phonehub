1. **Đặt tả Use Case**

**UC-M01-01: Đăng ký Tài khoản**

| Thuộc tính | Mô tả |
| --- | --- |
| **Actor** | Guest |
| **Trigger** | Khách hàng truy cập website và chọn chức năng "Đăng ký" trên thanh navbar giao diện chính. |
| **Mô tả** | Use case này cho phép khách hàng mới tạo một tài khoản trên hệ thống UTE Phone Hub bằng cách cung cấp thông tin cá nhân cần thiết. |
| **Điều kiện Tiên quyết** | - Khách hàng chưa có tài khoản trên hệ thống.
- Email cần đăng ký đúng định dạng và chưa từng được sử dụng để đăng ký. |
| **Kết quả Sau cùng** | - Tài khoản khách hàng được tạo thành công trong cơ sở dữ liệu với trạng thái "Hoạt động".
- Khách hàng nhận được email chào mừng.
- Khách hàng được điều hướng đến trang đăng nhập. |
| **Luồng Sự kiện Chính** | 1. Khách hàng chọn nút "Đăng nhập" trên thanh navbar giao diện chính.
2. Tại giao diện đăng nhập, chọn đăng ký. Hệ thống hiển thị trang Đăng ký với các trường thông tin.
3. Khách hàng nhập các thông tin bắt buộc: Họ tên, Email, Mật khẩu, Nhập lại mật khẩu.
5. Khách hàng nhấn nút "Đăng ký".
6. Hệ thống (Frontend) gửi yêu cầu đăng ký đến API Backend.
7. Hệ thống (Backend) thực hiện xác thực đầu vào:
a. Kiểm tra định dạng Email (ít nhất 6 ký tự, bao gồm ký tự @ và ký tự .).
b. Kiểm tra độ mạnh của Mật khẩu (ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường, số và ký tự đặc biệt).
c. Kiểm tra Mật khẩu và Nhập lại mật khẩu có khớp nhau không.
d. Kiểm tra xem Email đã tồn tại trong hệ thống chưa.
8. Nếu tất cả các bước xác thực đều thành công:
a. Hệ thống tạo một tài khoản người dùng mới với trạng thái "Hoạt động".
b. Mã hóa mật khẩu bằng BCrypt và lưu vào cơ sở dữ liệu.
c. Gửi một email chào mừng đến địa chỉ email của khách hàng.
d. Trả về thông báo thành công cho Frontend.
9. Hệ thống (Frontend) hiển thị thông báo thành công và chuyển hướng khách hàng về trang đăng nhập. |
| **Luồng Lỗi** | **7a, 7b, 7c. Dữ liệu không hợp lệ:** Hệ thống (Frontend) trả về lỗi 400 (Bad Request) với thông báo chi tiết. Frontend hiển thị thông báo lỗi tương ứng tại trường nhập liệu.
**7d. Email đã tồn tại:** Hệ thống (Frontend) trả về lỗi 409 (Conflict). Frontend hiển thị thông báo "Email này đã được sử dụng" và gợi ý đăng nhập hoặc quên mật khẩu.
**8c. Lỗi gửi email:** Hệ thống ghi nhận lỗi, nhưng vẫn tạo tài khoản và cho phép đăng ký thành công. |

**UC-M01-02: Đăng nhập bằng Email và Mật khẩu**

| Thuộc tính | Mô tả |
| --- | --- |
| **Actor** | CUSTOMER |
| **Trigger** | Khách hàng truy cập trang Đăng nhập và điền thông tin. |
| **Mô tả** | Cho phép khách hàng đã đăng ký truy cập vào tài khoản của mình bằng email hoặc tên đăng nhập và mật khẩu. |
| **Điều kiện Tiên quyết** | Khách hàng đã có tài khoản. |
| **Kết quả Sau cùng** | - Khách hàng đăng nhập thành công.
- Hệ thống tạo và trả về cặp JWT (Access Token & Refresh Token).
- Frontend lưu trữ token và điều hướng khách hàng đến trang chủ hoặc trang trước đó. |
| **Luồng Sự kiện Chính** | 1. Khách hàng truy cập trang Đăng nhập.
2. Khách hàng nhập Email và Mật khẩu.
3. Khách hàng nhấn nút "Đăng nhập".
4. Hệ thống (Frontend) gửi thông tin đăng nhập đến API Backend.
5. Hệ thống (Backend) tìm người dùng bằng email hoặc tên đăng nhập.
6. So sánh mật khẩu đã nhập với mật khẩu đã băm trong DB bằng BCrypt.
7. Nếu mật khẩu khớp, hệ thống kiểm tra trạng thái tài khoản (Active/Locked).
8. Hệ thống tạo một Access Token (thời hạn 24 giờ) và một Refresh Token (thời hạn 7 ngày).
9. Lưu Refresh Token vào Redis để quản lý.
10. Trả về cặp token và thông tin cơ bản của người dùng cho Frontend.
11. Hệ thống (Frontend) lưu trữ token (ví dụ: Access Token trong memory, Refresh Token trong HttpOnly cookie) và cập nhật trạng thái đăng nhập trên UI.
12. Điều hướng khách hàng đến trang chủ. |
| **Luồng Lỗi** | **5. Không tìm thấy email:** Hệ thống trả về lỗi 401 (Unauthorized) với thông báo "Email hoặc mật khẩu không chính xác".
**6. Mật khẩu không khớp:** Hệ thống trả về lỗi 401 (Unauthorized) với thông báo "Email hoặc mật khẩu không chính xác".
**7. Tài khoản bị khóa:** Hệ thống trả về lỗi 403 (Forbidden) với thông báo "Tài khoản của bạn đã bị khóa". |

**UC-M01-03: Đăng nhập bằng Google (OAuth2)**

| Thuộc tính | Mô tả |
| --- | --- |
| **Actor** | CUSTOMER |
| **Trigger** | Khách hàng chọn nút "Đăng nhập bằng Google" trên trang Đăng nhập/Đăng ký. |
| **Mô tả** | Cho phép khách hàng đăng nhập hoặc đăng ký nhanh chóng bằng tài khoản Google của họ. |
| **Điều kiện Tiên quyết** | Khách hàng có một tài khoản Google đang hoạt động. |
| **Kết quả Sau cùng** | - Khách hàng đăng nhập thành công.
- Nếu là người dùng mới, một tài khoản mới sẽ được tự động tạo và xác thực.
- Hệ thống tạo và trả về cặp JWT. |
| **Luồng Sự kiện Chính** | 1. Khách hàng nhấn nút "Đăng nhập bằng Google".
2. Hệ thống (Frontend) mở cửa sổ popup/redirect đến trang xác thực của Google.
3. Khách hàng đăng nhập vào tài khoản Google và đồng ý cấp quyền cho ứng dụng.
4. Google trả về một mã ủy quyền (authorization code) cho Frontend.
5. Hệ thống (Frontend) gửi mã ủy quyền này đến API Backend.
6. Hệ thống (Backend) dùng mã ủy quyền để trao đổi với Google và nhận về thông tin người dùng (email, họ tên).
7. Hệ thống (Backend) kiểm tra xem email nhận được từ Google đã tồn tại trong DB hay chưa.
 a. **Nếu đã tồn tại:** Tiến hành đăng nhập cho người dùng đó (chuyển đến bước 8 của UC-M01-02).
 b. **Nếu chưa tồn tại:** Tự động tạo một tài khoản mới với thông tin từ Google, đặt trạng thái là "Hoạt động", và tiến hành đăng nhập (chuyển đến bước 8 của UC-M01-02).
8. Hệ thống (Backend) trả về cặp JWT và thông tin người dùng cho Frontend.
9. Hệ thống (Frontend) lưu trữ token và điều hướng khách hàng đến trang chủ. |
| **Luồng Lỗi** | **3. Khách hàng từ chối cấp quyền:** Cửa sổ của Google đóng lại, không có hành động nào xảy ra.
**6. Lỗi giao tiếp với Google:** Hệ thống (Backend) trả về lỗi 500 (Internal Server Error). Frontend hiển thị thông báo "Đã có lỗi xảy ra với việc đăng nhập Google, vui lòng thử lại". |

**UC-M01-04: Đăng xuất**

| Thuộc tính | Mô tả |
| --- | --- |
| **Actor** | CUSTOMER |
| **Trigger** | Khách hàng chọn chức năng "Đăng xuất" trên giao diện. |
| **Mô tả** | Cho phép khách hàng kết thúc phiên làm việc và đăng xuất an toàn khỏi hệ thống. |
| **Điều kiện Tiên quyết** | Khách hàng đang trong một phiên đăng nhập hợp lệ. |
| **Kết quả Sau cùng** | - Phiên làm việc của khách hàng kết thúc.
- Refresh Token bị vô hiệu hóa.
- Frontend xóa bỏ các token đã lưu và cập nhật UI về trạng thái chưa đăng nhập. |
| **Luồng Sự kiện Chính** | 1. Khách hàng nhấn vào nút "Đăng xuất".
2. Hệ thống (Frontend) gửi yêu cầu đăng xuất đến API Backend, kèm theo Refresh Token.
3. Hệ thống (Backend) nhận Refresh Token và xóa nó khỏi Redis.
4. Hệ thống (Backend) trả về thông báo đăng xuất thành công.
5. Hệ thống (Frontend) xóa Access Token và Refresh Token khỏi bộ nhớ/cookie.
6. Cập nhật giao diện về trạng thái chưa đăng nhập và điều hướng về trang chủ. |

**UC-M01-05: Quên Mật khẩu**

| Thuộc tính | Mô tả |
| --- | --- |
| **Actor** | CUSTOMER |
| **Trigger** | Khách hàng chọn liên kết "Quên mật khẩu" trên trang Đăng nhập. |
| **Mô tả** | Cung cấp một quy trình an toàn để khách hàng có thể đặt lại mật khẩu của mình thông qua email. |
| **Điều kiện Tiên quyết** | Khách hàng phải nhớ và truy cập được địa chỉ email đã dùng để đăng ký tài khoản. |
| **Kết quả Sau cùng** | Mật khẩu của khách hàng được cập nhật thành công. |
| **Luồng Sự kiện Chính** | **Giai đoạn 1: Yêu cầu đặt lại mật khẩu**
1. Khách hàng nhấn "Quên mật khẩu".
2. Hệ thống hiển thị trang yêu cầu nhập email.
3. Khách hàng nhập email và nhấn "Gửi".
4. Hệ thống (Backend) kiểm tra email có tồn tại trong DB không.
5. Nếu có, hệ thống tạo một mã OTP (ví dụ: 6 chữ số), lưu vào Redis kèm email và thời gian hết hạn (ví dụ: 5 phút).
6. Hệ thống gửi email chứa mã OTP đến cho khách hàng.
7. Hệ thống (Frontend) điều hướng đến trang nhập OTP.
**Giai đoạn 2: Xác thực OTP và Đặt lại mật khẩu**
8. Khách hàng nhập mã OTP nhận được từ email.
9. Khách hàng nhập Mật khẩu mới và Nhập lại mật khẩu mới.
10. Khách hàng nhấn "Xác nhận".
11. Hệ thống (Backend) xác thực OTP (so sánh với giá trị trong Redis, kiểm tra chưa hết hạn).
12. Nếu OTP hợp lệ, hệ thống xác thực mật khẩu mới (độ mạnh, khớp nhau).
13. Hệ thống băm mật khẩu mới bằng BCrypt và cập nhật vào DB cho người dùng tương ứng.
14. Xóa OTP khỏi Redis.
15. Hệ thống (Frontend) hiển thị thông báo thành công và điều hướng đến trang Đăng nhập. |
| **Luồng Lỗi** | **4. Email không tồn tại:** Hệ thống vẫn hiển thị thông báo "Nếu email tồn tại, một mã OTP sẽ được gửi đi" để tránh việc dò email.
**11. OTP không chính xác hoặc hết hạn:** Hệ thống trả về lỗi. Frontend hiển thị thông báo "Mã OTP không hợp lệ hoặc đã hết hạn" và cung cấp tùy chọn gửi lại OTP.
**12. Mật khẩu mới không hợp lệ:** Frontend hiển thị thông báo lỗi tương ứng. |

**UC-M01-06: Cập nhật Thông tin cá nhân**

| Thuộc tính | Mô tả |
| --- | --- |
| **Actor** | CUSTOMER |
| **Trigger** | Khách hàng truy cập trang "Tài khoản của tôi" và chọn chỉnh sửa thông tin. |
| **Mô tả** | Cho phép khách hàng xem và cập nhật các thông tin cá nhân của mình như Họ tên, Số điện thoại. |
| **Điều kiện Tiên quyết** | Khách hàng đã đăng nhập. |
| **Kết quả Sau cùng** | Thông tin cá nhân của khách hàng được cập nhật thành công trong cơ sở dữ liệu. |
| **Luồng Sự kiện Chính** | 1. Khách hàng điều hướng đến trang "Hồ sơ cá nhân".
2. Hệ thống hiển thị thông tin hiện tại của khách hàng.
3. Khách hàng nhấn nút "Chỉnh sửa".
4. Khách hàng thay đổi các thông tin (ví dụ: Họ tên, Số điện thoại) và nhấn "Lưu thay đổi".
5. Hệ thống (Frontend) gửi yêu cầu cập nhật đến API Backend, kèm theo JWT trong header Authorization.
6. Hệ thống (Backend) xác thực JWT, lấy thông tin người dùng từ token.
7. Cập nhật thông tin mới vào bảng users trong DB.
8. Trả về thông tin người dùng đã được cập nhật.
9. Hệ thống (Frontend) hiển thị thông báo thành công và cập nhật lại thông tin trên giao diện. |

**UC-M01-07: Quản lý Địa chỉ Giao hàng**

| Thuộc tính | Mô tả |
| --- | --- |
| **Actor** | CUSTOMER |
| **Trigger** | Khách hàng truy cập trang "Quản lý địa chỉ" trong phần tài khoản. |
| **Mô tả** | Cho phép khách hàng thêm, xem, sửa, xóa các địa chỉ giao hàng và đặt một địa chỉ làm mặc định. |
| **Điều kiện Tiên quyết** | Khách hàng đã đăng nhập. |
| **Kết quả Sau cùng** | Danh sách địa chỉ của khách hàng được cập nhật trong cơ sở dữ liệu. |
| **Luồng Sự kiện Chính** | 1. Khách hàng truy cập trang "Quản lý địa chỉ".
2. Hệ thống hiển thị danh sách các địa chỉ đã lưu của khách hàng.
**Luồng A: Thêm địa chỉ mới**
 A1. Khách hàng nhấn "Thêm địa chỉ mới".
 A2. Hệ thống hiển thị form nhập thông tin địa chỉ (Họ tên người nhận, SĐT, Tỉnh/Thành, Phường/Xã, địa chỉ cụ thể).
 A3. Khách hàng điền thông tin và nhấn "Lưu".
 A4. Hệ thống (Backend) lưu địa chỉ mới vào bảng addresses và liên kết với người dùng.
 A5. Giao diện được cập nhật với địa chỉ mới.
**Luồng B: Sửa địa chỉ**
 B1. Khách hàng chọn "Sửa" trên một địa chỉ đã có.
 B2. Hệ thống hiển thị form với thông tin cũ, cho phép khách hàng chỉnh sửa.
 B3. Khách hàng nhấn "Lưu".
 B4. Hệ thống (Backend) cập nhật thông tin địa chỉ.
**Luồng C: Xóa địa chỉ**
 C1. Khách hàng chọn "Xóa" trên một địa chỉ.
 C2. Hệ thống hiển thị hộp thoại xác nhận.
 C3. Khách hàng xác nhận xóa.
 C4. Hệ thống (Backend) xóa địa chỉ khỏi DB.
**Luồng D: Đặt làm mặc định**
 D1. Khách hàng chọn "Đặt làm mặc định" trên một địa chỉ không phải là mặc định.
 D2. Hệ thống (Backend) cập nhật trạng thái mặc định cho địa chỉ này và bỏ trạng thái mặc định của địa chỉ cũ (nếu có). |