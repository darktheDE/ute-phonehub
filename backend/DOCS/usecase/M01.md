1. **Đặt tả Use Case**

# 2.1. Đăng ký Tài khoản

| **[UC-M01-01]** | **Đăng ký Tài khoản** |
| --- | --- |
| **Actor** | Guest |
| **Trigger** | Khách hàng truy cập website và chọn chức năng "Đăng ký" trên thanh navbar giao diện chính. |
| **Description** | Use case này cho phép khách hàng mới tạo một tài khoản trên hệ thống UTE Phone Hub bằng cách cung cấp thông tin cá nhân cần thiết. |
| **Pre-Conditions** | - Khách hàng chưa có tài khoản trên hệ thống.<br>- Email cần đăng ký đúng định dạng và chưa từng được sử dụng để đăng ký. |
| **Post-Conditions** | - Tài khoản khách hàng được tạo thành công trong cơ sở dữ liệu với trạng thái "Hoạt động".<br>- Khách hàng nhận được email chào mừng.<br>- Khách hàng được điều hướng đến trang đăng nhập. |
| **Main Flow** | 1. Khách hàng chọn nút "Đăng nhập" trên thanh navbar giao diện chính.<br>2. Tại giao diện đăng nhập, chọn đăng ký. Hệ thống hiển thị trang Đăng ký với các trường thông tin.<br>3. Khách hàng nhập các thông tin bắt buộc: Họ tên, Email, Mật khẩu, Nhập lại mật khẩu.<br>4. Khách hàng nhấn nút "Đăng ký".<br>5. Hệ thống (Frontend) gửi yêu cầu đăng ký đến API Backend.<br>6. Hệ thống (Backend) thực hiện xác thực đầu vào:<br>&nbsp;&nbsp;&nbsp;&nbsp;6.A. Kiểm tra định dạng Email (ít nhất 6 ký tự, bao gồm ký tự @ và ký tự .).<br>&nbsp;&nbsp;&nbsp;&nbsp;6.B. Kiểm tra độ mạnh của Mật khẩu (ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường, số và ký tự đặc biệt).<br>&nbsp;&nbsp;&nbsp;&nbsp;6.C. Kiểm tra Mật khẩu và Nhập lại mật khẩu có khớp nhau không.<br>&nbsp;&nbsp;&nbsp;&nbsp;6.D. Kiểm tra xem Email đã tồn tại trong hệ thống chưa.<br>7. Nếu tất cả các bước xác thực đều thành công:<br>&nbsp;&nbsp;&nbsp;&nbsp;7.A. Hệ thống tạo một tài khoản người dùng mới với trạng thái "Hoạt động".<br>&nbsp;&nbsp;&nbsp;&nbsp;7.B. Mã hóa mật khẩu bằng BCrypt và lưu vào cơ sở dữ liệu.<br>&nbsp;&nbsp;&nbsp;&nbsp;7.C. Gửi một email chào mừng đến địa chỉ email của khách hàng.<br>&nbsp;&nbsp;&nbsp;&nbsp;7.D. Trả về thông báo thành công cho Frontend.<br>8. Hệ thống (Frontend) hiển thị thông báo thành công và chuyển hướng khách hàng về trang đăng nhập. |
| **Alternate Flow** | Không có. |
| **Exception Flow** | + 6.A, 6.B, 6.C, 6.D. Dữ liệu không hợp lệ: Hệ thống (Frontend) trả về lỗi 400 (Bad Request) với thông báo chi tiết. Frontend hiển thị thông báo lỗi tương ứng tại trường nhập liệu.<br>+ 6.D. Email đã tồn tại: Hệ thống (Frontend) trả về lỗi 409 (Conflict). Frontend hiển thị thông báo "Email này đã được sử dụng" và gợi ý đăng nhập hoặc quên mật khẩu.<br>+ 7.C. Lỗi gửi email: Hệ thống ghi nhận lỗi, nhưng vẫn tạo tài khoản và cho phép đăng ký thành công. |

# 2.2. Đăng nhập hệ thống

| **[UC-M01-02]** | **Đăng nhập bằng Email và Mật khẩu** |
| --- | --- |
| **Actor** | CUSTOMER |
| **Trigger** | Khách hàng truy cập trang Đăng nhập và điền thông tin. |
| **Description** | Cho phép khách hàng đã đăng ký truy cập vào tài khoản của mình bằng email hoặc tên đăng nhập và mật khẩu. |
| **Pre-Conditions** | Khách hàng đã có tài khoản. |
| **Post-Conditions** | - Khách hàng đăng nhập thành công.<br>- Hệ thống tạo và trả về cặp JWT (Access Token & Refresh Token).<br>- Frontend lưu trữ token và điều hướng khách hàng đến trang chủ hoặc trang trước đó. |
| **Main Flow** | 1. Khách hàng truy cập trang Đăng nhập.<br>2. Khách hàng nhập Email và Mật khẩu.<br>3. Khách hàng nhấn nút "Đăng nhập".<br>4. Hệ thống (Frontend) gửi thông tin đăng nhập đến API Backend.<br>5. Hệ thống (Backend) tìm người dùng bằng email hoặc tên đăng nhập.<br>6. So sánh mật khẩu đã nhập với mật khẩu đã băm trong DB bằng BCrypt.<br>7. Nếu mật khẩu khớp, hệ thống kiểm tra trạng thái tài khoản (Active/Locked).<br>8. Hệ thống tạo một Access Token (thời hạn 24 giờ) và một Refresh Token (thời hạn 7 ngày).<br>9. Lưu Refresh Token vào Redis để quản lý.<br>10. Trả về cặp token và thông tin cơ bản của người dùng cho Frontend.<br>11. Hệ thống (Frontend) lưu trữ token (ví dụ: Access Token trong memory, Refresh Token trong HttpOnly cookie) và cập nhật trạng thái đăng nhập trên UI.<br>12. Điều hướng khách hàng đến trang chủ. |
| **Alternate Flow** | Không có. |
| **Exception Flow** | + 5. Không tìm thấy email: Hệ thống trả về lỗi 401 (Unauthorized) với thông báo "Email hoặc mật khẩu không chính xác".<br>+ 6. Mật khẩu không khớp: Hệ thống trả về lỗi 401 (Unauthorized) với thông báo "Email hoặc mật khẩu không chính xác".<br>+ 7. Tài khoản bị khóa: Hệ thống trả về lỗi 403 (Forbidden) với thông báo "Tài khoản của bạn đã bị khóa". |

# 2.3. Đăng nhập Google (OAuth2)

| **[UC-M01-03]** | **Đăng nhập bằng Google** |
| --- | --- |
| **Actor** | CUSTOMER |
| **Trigger** | Khách hàng chọn nút "Đăng nhập bằng Google" trên trang Đăng nhập/Đăng ký. |
| **Description** | Cho phép khách hàng đăng nhập hoặc đăng ký nhanh chóng bằng tài khoản Google của họ. |
| **Pre-Conditions** | Khách hàng có một tài khoản Google đang hoạt động. |
| **Post-Conditions** | - Khách hàng đăng nhập thành công.<br>- Nếu là người dùng mới, một tài khoản mới sẽ được tự động tạo và xác thực.<br>- Hệ thống tạo và trả về cặp JWT. |
| **Main Flow** | 1. Khách hàng nhấn nút "Đăng nhập bằng Google".<br>2. Hệ thống (Frontend) mở cửa sổ popup/redirect đến trang xác thực của Google.<br>3. Khách hàng đăng nhập vào tài khoản Google và đồng ý cấp quyền cho ứng dụng.<br>4. Google trả về một mã ủy quyền (authorization code) cho Frontend.<br>5. Hệ thống (Frontend) gửi mã ủy quyền này đến API Backend.<br>6. Hệ thống (Backend) dùng mã ủy quyền để trao đổi với Google và nhận về thông tin người dùng (email, họ tên).<br>7. Hệ thống (Backend) kiểm tra xem email nhận được từ Google đã tồn tại trong DB hay chưa.<br>&nbsp;&nbsp;&nbsp;&nbsp;7.A. Nếu đã tồn tại: Tiến hành đăng nhập cho người dùng đó (chuyển đến bước 8 của UC-M01-02).<br>&nbsp;&nbsp;&nbsp;&nbsp;7.B. Nếu chưa tồn tại: Tự động tạo một tài khoản mới với thông tin từ Google, đặt trạng thái là "Hoạt động", và tiến hành đăng nhập (chuyển đến bước 8 của UC-M01-02).<br>8. Hệ thống (Backend) trả về cặp JWT và thông tin người dùng cho Frontend.<br>9. Hệ thống (Frontend) lưu trữ token và điều hướng khách hàng đến trang chủ. |
| **Alternate Flow** | Không có. |
| **Exception Flow** | + 3. Khách hàng từ chối cấp quyền: Cửa sổ của Google đóng lại, không có hành động nào xảy ra.<br>+ 6. Lỗi giao tiếp với Google: Hệ thống (Backend) trả về lỗi 500 (Internal Server Error). Frontend hiển thị thông báo "Đã có lỗi xảy ra với việc đăng nhập Google, vui lòng thử lại". |

# 2.4. Đăng xuất

| **[UC-M01-04]** | **Đăng xuất** |
| --- | --- |
| **Actor** | CUSTOMER |
| **Trigger** | Khách hàng chọn chức năng "Đăng xuất" trên giao diện. |
| **Description** | Cho phép khách hàng kết thúc phiên làm việc và đăng xuất an toàn khỏi hệ thống. |
| **Pre-Conditions** | Khách hàng đang trong một phiên đăng nhập hợp lệ. |
| **Post-Conditions** | - Phiên làm việc của khách hàng kết thúc.<br>- Refresh Token bị vô hiệu hóa.<br>- Frontend xóa bỏ các token đã lưu và cập nhật UI về trạng thái chưa đăng nhập. |
| **Main Flow** | 1. Khách hàng nhấn vào nút "Đăng xuất".<br>2. Hệ thống (Frontend) gửi yêu cầu đăng xuất đến API Backend, kèm theo Refresh Token.<br>3. Hệ thống (Backend) nhận Refresh Token và xóa nó khỏi Redis.<br>4. Hệ thống (Backend) trả về thông báo đăng xuất thành công.<br>5. Hệ thống (Frontend) xóa Access Token và Refresh Token khỏi bộ nhớ/cookie.<br>6. Cập nhật giao diện về trạng thái chưa đăng nhập và điều hướng về trang chủ. |
| **Alternate Flow** | Không có. |
| **Exception Flow** | Không có. |

# 2.5. Quên Mật khẩu

| **[UC-M01-05]** | **Quên Mật khẩu** |
| --- | --- |
| **Actor** | CUSTOMER |
| **Trigger** | Khách hàng chọn liên kết "Quên mật khẩu" trên trang Đăng nhập. |
| **Description** | Cung cấp một quy trình an toàn để khách hàng có thể đặt lại mật khẩu của mình thông qua email. |
| **Pre-Conditions** | Khách hàng phải nhớ và truy cập được địa chỉ email đã dùng để đăng ký tài khoản. |
| **Post-Conditions** | Mật khẩu của khách hàng được cập nhật thành công. |
| **Main Flow** | **Giai đoạn 1: Yêu cầu đặt lại mật khẩu**<br>1. Khách hàng nhấn "Quên mật khẩu".<br>2. Hệ thống hiển thị trang yêu cầu nhập email.<br>3. Khách hàng nhập email và nhấn "Gửi".<br>4. Hệ thống (Backend) kiểm tra email có tồn tại trong DB không.<br>5. Nếu có, hệ thống tạo một mã OTP (ví dụ: 6 chữ số), lưu vào Redis kèm email và thời gian hết hạn (ví dụ: 5 phút).<br>6. Hệ thống gửi email chứa mã OTP đến cho khách hàng.<br>7. Hệ thống (Frontend) điều hướng đến trang nhập OTP.<br><br>**Giai đoạn 2: Xác thực OTP và Đặt lại mật khẩu**<br>8. Khách hàng nhập mã OTP nhận được từ email.<br>9. Khách hàng nhập Mật khẩu mới và Nhập lại mật khẩu mới.<br>10. Khách hàng nhấn "Xác nhận".<br>11. Hệ thống (Backend) xác thực OTP (so sánh với giá trị trong Redis, kiểm tra chưa hết hạn).<br>12. Nếu OTP hợp lệ, hệ thống xác thực mật khẩu mới (độ mạnh, khớp nhau).<br>13. Hệ thống băm mật khẩu mới bằng BCrypt và cập nhật vào DB cho người dùng tương ứng.<br>14. Xóa OTP khỏi Redis.<br>15. Hệ thống (Frontend) hiển thị thông báo thành công và điều hướng đến trang Đăng nhập. |
| **Alternate Flow** | Không có. |
| **Exception Flow** | + 4. Email không tồn tại: Hệ thống vẫn hiển thị thông báo "Nếu email tồn tại, một mã OTP sẽ được gửi đi" để tránh việc dò email.<br>+ 11. OTP không chính xác hoặc hết hạn: Hệ thống trả về lỗi. Frontend hiển thị thông báo "Mã OTP không hợp lệ hoặc đã hết hạn" và cung cấp tùy chọn gửi lại OTP.<br>+ 12. Mật khẩu mới không hợp lệ: Frontend hiển thị thông báo lỗi tương ứng. |

# 2.6. Cập nhật Thông tin cá nhân

| **[UC-M01-06]** | **Cập nhật Thông tin cá nhân** |
| --- | --- |
| **Actor** | CUSTOMER |
| **Trigger** | Khách hàng truy cập trang "Tài khoản của tôi" và chọn chỉnh sửa thông tin. |
| **Description** | Cho phép khách hàng xem và cập nhật các thông tin cá nhân của mình như Họ tên, Số điện thoại. |
| **Pre-Conditions** | Khách hàng đã đăng nhập. |
| **Post-Conditions** | Thông tin cá nhân của khách hàng được cập nhật thành công trong cơ sở dữ liệu. |
| **Main Flow** | 1. Khách hàng điều hướng đến trang "Hồ sơ cá nhân".<br>2. Hệ thống hiển thị thông tin hiện tại của khách hàng.<br>3. Khách hàng nhấn nút "Chỉnh sửa".<br>4. Khách hàng thay đổi các thông tin (ví dụ: Họ tên, Số điện thoại) và nhấn "Lưu thay đổi".<br>5. Hệ thống (Frontend) gửi yêu cầu cập nhật đến API Backend, kèm theo JWT trong header Authorization.<br>6. Hệ thống (Backend) xác thực JWT, lấy thông tin người dùng từ token.<br>7. Cập nhật thông tin mới vào bảng users trong DB.<br>8. Trả về thông tin người dùng đã được cập nhật.<br>9. Hệ thống (Frontend) hiển thị thông báo thành công và cập nhật lại thông tin trên giao diện. |
| **Alternate Flow** | Không có. |
| **Exception Flow** | Không có. |

# 2.7. Quản lý Địa chỉ Giao hàng

| **[UC-M01-07]** | **Quản lý Địa chỉ Giao hàng** |
| --- | --- |
| **Actor** | CUSTOMER |
| **Trigger** | Khách hàng truy cập trang "Quản lý địa chỉ" trong phần tài khoản. |
| **Description** | Cho phép khách hàng thêm, xem, sửa, xóa các địa chỉ giao hàng và đặt một địa chỉ làm mặc định. |
| **Pre-Conditions** | Khách hàng đã đăng nhập. |
| **Post-Conditions** | Danh sách địa chỉ của khách hàng được cập nhật trong cơ sở dữ liệu. |
| **Main Flow** | 1. Khách hàng truy cập trang "Quản lý địa chỉ".<br>2. Hệ thống hiển thị danh sách các địa chỉ đã lưu của khách hàng.<br><br>**Luồng A: Thêm địa chỉ mới**<br>A1. Khách hàng nhấn "Thêm địa chỉ mới".<br>A2. Hệ thống hiển thị form nhập thông tin địa chỉ (Họ tên người nhận, SĐT, Tỉnh/Thành, Phường/Xã, địa chỉ cụ thể).<br>A3. Khách hàng điền thông tin và nhấn "Lưu".<br>A4. Hệ thống (Backend) lưu địa chỉ mới vào bảng addresses và liên kết với người dùng.<br>A5. Giao diện được cập nhật với địa chỉ mới.<br><br>**Luồng B: Sửa địa chỉ**<br>B1. Khách hàng chọn "Sửa" trên một địa chỉ đã có.<br>B2. Hệ thống hiển thị form với thông tin cũ, cho phép khách hàng chỉnh sửa.<br>B3. Khách hàng nhấn "Lưu".<br>B4. Hệ thống (Backend) cập nhật thông tin địa chỉ.<br><br>**Luồng C: Xóa địa chỉ**<br>C1. Khách hàng chọn "Xóa" trên một địa chỉ.<br>C2. Hệ thống hiển thị hộp thoại xác nhận.<br>C3. Khách hàng xác nhận xóa.<br>C4. Hệ thống (Backend) xóa địa chỉ khỏi DB.<br><br>**Luồng D: Đặt làm mặc định**<br>D1. Khách hàng chọn "Đặt làm mặc định" trên một địa chỉ không phải là mặc định.<br>D2. Hệ thống (Backend) cập nhật trạng thái mặc định cho địa chỉ này và bỏ trạng thái mặc định của địa chỉ cũ (nếu có). |
| **Alternate Flow** | Không có. |
| **Exception Flow** | Không có. |

# 2.8. Gửi Email OTP

| **[UC-M01-08]** | **Gửi Email OTP** |
| --- | --- |
| **Actor** | System (Email Service) |
| **Trigger** | Được kích hoạt bởi Use Case "Quên Mật khẩu" hoặc "Đăng ký" (nếu có xác thực email). |
| **Description** | Hệ thống gửi email chứa mã OTP đến người dùng để xác thực quyền sở hữu email. |
| **Pre-Conditions** | - Email người nhận hợp lệ.<br>- Mã OTP đã được tạo. |
| **Post-Conditions** | Email chứa mã OTP được gửi đến hộp thư người dùng. |
| **Main Flow** | 1. Component yêu cầu (AuthService) gọi EmailService.sendOtpEmail().<br>2. EmailService chuẩn bị template email HTML (cấu trúc Thymeleaf), điền OTP và tên người dùng.<br>3. Hệ thống tạo MimeMessage.<br>4. Gửi email qua SMTP server (JavaMailSender).<br>5. Ghi log trạng thái gửi thành công. |
| **Alternate Flow** | Không có. |
| **Exception Flow** | + 4. Lỗi kết nối SMTP: Hệ thống ném ngoại lệ EmailServiceException. Log lỗi chi tiết. |

# 2.9. Gửi Email Thanh toán Thành công

| **[UC-M01-09]** | **Gửi Email Thanh toán Thành công** |
| --- | --- |
| **Actor** | System (Email Service) |
| **Trigger** | Được kích hoạt bởi Use Case "Thanh toán Đơn hàng" khi thanh toán thành công. |
| **Description** | Hệ thống gửi email xác nhận chi tiết đơn hàng và thanh toán đến khách hàng sau khi hoàn tất giao dịch. |
| **Pre-Conditions** | - Đơn hàng đã được tạo và thanh toán thành công.<br>- Có thông tin email người nhận. |
| **Post-Conditions** | Email xác nhận đơn hàng được gửi đến hộp thư khách hàng. |
| **Main Flow** | 1. Component PaymentService/OrderService gọi EmailService.sendOrderPaymentSuccessEmail().<br>2. EmailService chuẩn bị data context (Mã đơn hàng, Tổng tiền, Tên người nhận, Phương thức thanh toán, Thời gian).<br>3. Render template HTML `order-payment-success`.<br>4. Gửi email qua SMTP server.<br>5. Ghi log trạng thái gửi thành công. |
| **Alternate Flow** | Không có. |
| **Exception Flow** | + 4. Lỗi kết nối SMTP: Hệ thống ghi log lỗi nhưng không rollback giao dịch thanh toán (Email là bước phụ). |