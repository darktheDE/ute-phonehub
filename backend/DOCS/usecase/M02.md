***Admin***

Admin

- Xem danh sách sản phẩm

Lọc sản phẩm

Tìm kiếm sản phẩm

Export danh sách

- Quản lý sản phẩm (CRUD + Soft Delete)

Thêm sản phẩm mới

Cập nhật thông tin sản phẩm

Xóa mềm sản phẩm (Soft Delete)

Khôi phục sản phẩm đã xóa

- Quản lý hình ảnh sản phẩm

Upload nhiều ảnh

Sắp xếp thứ tự ảnh

Đặt ảnh chính

Xóa ảnh

**1. Xem danh sách sản phẩm**

| Actor | Admin |
| --- | --- |
| Trigger | Admin truy cập trang "Quản lý sản phẩm" |
| Description | Hiển thị danh sách sản phẩm với phân trang, lọc, tìm kiếm |
| Pre-Conditions | Admin đã đăng nhập |
| Post-Conditions | Danh sách được hiển thị |
| Main Flow | 1. Admin vào menu "Quản lý sản phẩm"
2. Hệ thống hiển thị dashboard stats (Total, Active, Inactive, Deleted, Low Stock)
3. Hiển thị bảng: Ảnh | Tên | SKU | Giá | Tồn kho | Status | Actions
4. Phân trang 20 items/page
5. Admin có thể filter, search, sort, bulk actions |
| Alternate Flow | AF-1: Không có sản phẩm → "Chưa có sản phẩm"
AF-2: Lọc/tìm kiếm không có kết quả → "Không tìm thấy" |
- Chi tiết Lọc sản phẩm
- Tiêu chí lọc:

- Category: Dropdown/multi-select danh mục (VD: Điện thoại, Laptop, Phụ kiện)

- Brand: Dropdown/multi-select thương hiệu (VD: Samsung, Apple, Xiaomi)

- Price Range: Slider hoặc input min-max (0 - 50,000,000 VND)

- Stock Level: Dropdown (Tất cả | Còn hàng >0 | Sắp hết <10 | Hết hàng =0)

- Status: Checkbox (Active | Inactive | Deleted)

- Created Date: Chọn ngày (từ ngày - đến ngày)

- Logic kết hợp: AND logic ( thỏa all điều kiện đã chọn)
- UI behavior: Apply filter ngay (AJAX), hiển thị "Tìm thấy X sản phẩm", button "Clear All Filters"
- Chi tiết Search (Tìm kiếm):
- Trường tìm kiếm:

- Tên sản phẩm: fuzzy matching, không phân biệt hoa/thường

- SKU: exact match, case-insensitive

- Mô tả: full-text search

- Cơ chế: Debounce 500ms (tự động search sau 0.5s kể từ lần gõ cuối), highlight từ khóa, kết hợp với filter
- UI: Search box placeholder "Tìm theo tên, SKU, mô tả...", icon search + button "X" clear
- Pagination & Sorting:
- Pagination:

- Default: 20 items/page

- Options: 10, 20, 50, 100 items/page

- UI: Previous | 1 2 3 ... | Next

- Show: "Hiển thị 1-20 của X sản phẩm"

- Sorting:

- Default: created_at DESC (mới nhất trước)

- Options: Tên A-Z/Z-A, Giá thấp→cao/cao→thấp, Tồn kho thấp→cao, Ngày tạo mới→cũ/cũ→mới

**2. Thêm sản phẩm mới**

| Actor | Admin |
| --- | --- |
| Trigger | Admin click "Thêm sản phẩm mới" |
| Description | Tạo sản phẩm với thông tin cơ bản, thông số kỹ thuật và hình ảnh |
| Pre-Conditions | Admin có quyền CREATE_PRODUCT |
| Post-Conditions | Sản phẩm mới được lưu vào database |
| Main Flow | 1. Admin click "Thêm sản phẩm"
2. Hiển thị form: Tên(*), SKU, Giá(*), Category(*), Brand(*), Stock(*), Thông số kỹ thuật, Ảnh(*) max 10, Mô tả(*)
3. Admin nhập đầy đủ thông tin + upload ảnh
4. Click "Lưu"
5. Validate: required, format, SKU unique, ảnh (JPG/PNG/WebP, max 5MB)
6. Upload ảnh → server/cloud
7. Lưu database + ghi log audit
8. Hiện "Thêm thành công!" |
| Alternate Flow | AF-1: Validation lỗi → Hiển thị errors
AF-2: SKU trùng → "SKU đã tồn tại"
AF-3: Click "Hủy" → Confirm → Quay về |
| Exception Flow | EF-1: Validation errors:
  - Tên trống/quá ngắn (<5 ký tự)/quá dài (>200 ký tự) → "Tên sản phẩm phải từ 5-200 ký tự"
  - SKU sai format → "SKU chỉ chứa chữ hoa, số và dấu gạch ngang (6-20 ký tự)"
  - Giá ≤ 0 → "Giá phải lớn hơn 0"
  - Stock < 0 → "Số lượng tồn kho không hợp lệ"
  - Category/Brand không tồn tại → "Danh mục/Thương hiệu không tồn tại"
  - Không upload ảnh → "Cần ít nhất 1 ảnh sản phẩm"
  - Ảnh sai format/quá lớn → "Ảnh phải là JPG/PNG/WebP, tối đa 5MB"
EF-2: Upload ảnh thất bại:
  - Network timeout → Retry upload 3 lần, hiển thị "Lỗi kết nối. Đang thử lại"
  - Storage full → "Không đủ dung lượng lưu trữ."
  - Upload một phần thất bại → Rollback tất cả ảnh đã upload, yêu cầu upload lại
 
EF-3: Database errors:
  - Connection timeout → Retry 3 lần, hiển thị "Lỗi kết nối database. Vui lòng thử lại"
  - Transaction rollback → Xóa ảnh đã upload, hiển thị "Lỗi lưu dữ liệu. Vui lòng thử lại"
  - Constraint violation → "Lỗi ràng buộc dữ liệu. Kiểm tra lại thông tin" |
- Chi tiết Thông số kỹ thuật
- Kiểu dữ liệu: JSONB (PostgreSQL) - lưu linh hoạt key-value
- Schema chuẩn (cho điện thoại):

```json

{

"screen": {

"size": "6.7 inch",

"resolution": "2796 x 1290",

"tech": "Super Retina XDR OLED"

},

"cpu": "Apple A17 Pro",

"ram": "8GB",

"storage": "256GB",

"battery": "4422mAh",

"camera": {

"rear": "48MP + 12MP + 12MP",

"front": "12MP"

},

"os": "iOS 17",

"weight": "221g",

"sim": "Dual SIM (nano-SIM and eSIM)"

}

```

- Validation rules:

- screen.size: string, pattern "X.X inch"

- ram: string, pattern "XGB" (4GB, 6GB, 8GB, 12GB, 16GB...)

- storage: string, pattern "XGB" hoặc "XTB"

- battery: string, pattern "XmAh"

- Các field khác: string, max 200 ký tự

- UI Form:

- Dynamic form với key-value pairs

- Button "Thêm thông số" để add field mới

- Autocomplete gợi ý cho key thông dụng (screen, ram, storage...)

- Preview JSON ở sidebar

**3. Cập nhật sản phẩm**

| Actor | Admin |
| --- | --- |
| Trigger | Admin click "Edit" |
| Description | Chỉnh sửa thông tin sản phẩm |
| Pre-Conditions | Admin có quyền UPDATE_PRODUCT |
| Post-Conditions | Sản phẩm được cập nhật |
| Main Flow | 1. Admin click "Edit"
2. Load form pre-fill dữ liệu cũ
3. Admin sửa thông tin cần thiết
4. Click "Cập nhật"
5. Validate + so sánh changes
6. Update database + log audit + clear cache
7. Hiện "Cập nhật thành công!" |
| Alternate Flow | AF-1: Không có thay đổi → "Không có thay đổi" |
| Exception Flow | EF-1: Validation errors (tương tự UC 2):
  - Tên/SKU/Giá/Stock không hợp lệ → Hiển thị lỗi field tương ứng
  - SKU trùng với sản phẩm khác → "SKU đã được sử dụng bởi sản phẩm khác"
 
EF-2: Concurrent modification (2 admin sửa cùng lúc):
  - Optimistic locking: Check updated_at trước khi UPDATE
  - Nếu updated_at khác → Hiển thị "Sản phẩm đã được cập nhật bởi người khác. Vui lòng tải lại"
  - Reload form với dữ liệu mới nhất
 
EF-3: Sản phẩm đã bị xóa:
  - Nếu sản phẩm is_deleted=TRUE → "Sản phẩm không tồn tại hoặc đã bị xóa"
  - Redirect về danh sách
 
EF-4: Upload/Delete ảnh thất bại:
  - Upload ảnh mới fail → Keep old images, hiển thị "Upload ảnh mới thất bại"
  - Delete ảnh cũ fail → Keep in DB, log warning
  - Partial update: Lưu text fields trước, retry ảnh sau
 
EF-5: Database errors:
  - Deadlock → Retry sau 1s, max 3 lần
  - Constraint violation → Rollback, hiển thị lỗi cụ thể |

**4. Xóa mềm sản phẩm (Soft Delete)**

| Actor | Admin |
| --- | --- |
| Trigger | Admin click "Delete" |
| Description | Đánh dấu sản phẩm đã xóa nhưng giữ lại dữ liệu |
| Pre-Conditions | Admin có quyền DELETE_PRODUCT |
| Post-Conditions | is_deleted=TRUE, không hiển thị frontend |
| Main Flow | 1. Admin click "Delete"
2. Confirm: "Sản phẩm sẽ vào thùng rác. Khôi phục được trong 30 ngày"
3. Kiểm tra: Có đơn hàng pending không?
4. UPDATE: is_deleted=TRUE, deleted_at=NOW(), status='DELETED'
5. Ghi log + clear cache
6. Hiện "Đã xóa. [Hoàn tác 5s]" |
| Alternate Flow | AF-1: Có đơn hàng pending → "Không thể xóa"
AF-2: Click "Hoàn tác" → Restore ngay |
| Exception Flow | EF-1: Sản phẩm đã bị xóa:
  - Nếu is_deleted=TRUE → "Sản phẩm đã được chuyển vào thùng rác"
 
EF-2: Kiểm tra đơn hàng thất bại:
  - Query orders timeout → "Không thể kiểm tra đơn hàng. Vui lòng thử lại"
  - Có đơn hàng PENDING/CONFIRMED/SHIPPING → "Không thể xóa. Sản phẩm có X đơn hàng chưa hoàn thành"
 
EF-3: Database errors:
  - UPDATE fail → Rollback, "Xóa thất bại. Vui lòng thử lại"
  - Cache clear fail → Log warning, continue (cache sẽ expire tự động) |

**5. Khôi phục sản phẩm**

| Actor | Admin |
| --- | --- |
| Trigger | Admin click "Restore" trong "Thùng rác" |
| Description | Khôi phục sản phẩm đã xóa |
| Pre-Conditions | Sản phẩm đã xóa, chưa quá 30 ngày |
| Post-Conditions | Sản phẩm về trạng thái INACTIVE |
| Main Flow | 1. Admin vào tab "Thùng rác" 
2. Hiển thị DS đã xóa: Tên | Deleted by | Deleted at | Countdown | Actions 
3. Click "Restore" 
4. Confirm 
5. UPDATE: is_deleted=FALSE, deleted_at=NULL, status='INACTIVE'
6. Hiện "Khôi phục thành công!" |
| Exception Flow | EF-1: Sản phẩm không thể khôi phục:
  - Chưa bị xóa (is_deleted=FALSE) → "Sản phẩm không trong thùng rác"
  - Đã quá 30 ngày (deleted_at < NOW() - 30 days) → "Sản phẩm đã bị xóa vĩnh viễn"
 
EF-2: Dữ liệu liên kết không tồn tại:
  - Category đã bị xóa → "Không thể khôi phục. Danh mục không còn tồn tại"
  - Brand đã bị xóa → "Không thể khôi phục. Thương hiệu không còn tồn tại"
  - Hiển thị option: "Chọn danh mục/thương hiệu mới" hoặc "Hủy"
 
EF-3: SKU conflict:
  - Có sản phẩm khác đã dùng SKU này → "SKU đã tồn tại. Vui lòng đổi SKU trước khi khôi phục"
  - Show input để sửa SKU
 
EF-4: Database errors:
  - UPDATE fail → "Khôi phục thất bại. Vui lòng thử lại" |

**6. Quản lý hình ảnh**

| Actor | Admin |
| --- | --- |
| Trigger | Admin ở form Create/Edit, thao tác với Images section |
| Description | Upload, sắp xếp, đặt ảnh chính, xóa ảnh |
| Pre-Conditions | Đang tạo/sửa sản phẩm |
| Post-Conditions | Ảnh được quản lý |
| Main Flow | 1. Upload: Drag & drop → Validate (format, size, max 10) → Upload → Preview
2. Reorder: Drag thumbnail → Update image_order
3. Set Main: Click "Set as main" → is_main=TRUE
4. Delete: Click "X" → Confirm → Xóa |
| Exception Flow | EF-1: Upload errors:
  - File không phải ảnh → "File phải là ảnh JPG/PNG/WebP"
  - File > 5MB → "Ảnh không được vượt quá 5MB"
  - Dimensions < 500x500px → "Ảnh tối thiểu 500x500 pixels"
  - Quá 10 ảnh → "Tối đa 10 ảnh cho 1 sản phẩm"
  - Upload timeout → Retry 3 lần, "Upload thất bại. Vui lòng thử lại"
  - Virus detected → "File không an toàn. Vui lòng chọn file khác"
 
EF-2: Storage errors:
  - Cloud storage unreachable → Fallback to local storage (temporary), retry upload sau
  - Storage quota exceeded → "Hết dung lượng lưu trữ. Liên hệ admin"
  - Upload partial fail → Rollback all, "Upload không hoàn chỉnh. Vui lòng thử lại"
 
EF-3: Delete errors:
  - Xóa ảnh cuối cùng → "Không thể xóa. Sản phẩm cần ít nhất 1 ảnh"
  - Cloud delete fail → Remove from DB anyway, schedule cleanup job
  - Ảnh đang được dùng ở đơn hàng → Warning "Ảnh đang hiển thị trong đơn hàng. Vẫn xóa?"
 
EF-4: Reorder/Set main errors:
   - Invalid image_order → Reset về 0,1,2... sequence
  - Conflict is_main (multiple TRUE) → giữ cái đầu, chuyển toàn bộ thành FALSE
  - DB update fail → tải lại UI vs trạng thái hiện tại |
- Chi tiết Quản lý hình ảnh:
- Quy tắc ảnh:

- Formats: JPG, PNG, WebP

- Max size: 5MB/ảnh

- Max images: 10 ảnh/sản phẩm

- Min images: 1 ảnh (bắt buộc)

- Thuộc tính:

- image_order: integer (0, 1, 2...) - thứ tự hiển thị

- is_main: boolean - đánh dấu ảnh chính (chỉ 1 ảnh is_main=TRUE)

- alt_text: string (optional) - mô tả ảnh cho SEO

- Logic xử lý:

- Upload: Ảnh đầu tiên tự động là ảnh chính (is_main=TRUE)

- Reorder: Drag & drop cập nhật image_order (0→9)

- Set main: Khi set ảnh mới làm main → ảnh cũ is_main=FALSE

- Delete: Nếu xóa ảnh main → promote ảnh tiếp theo (image_order nhỏ nhất) làm main

- Background processing:

- Sau upload: resize/optimize ảnh (3 sizes: 800x800, 400x400, 100x100)

- Store URLs trong DB: original_url, large_url, medium_url, thumb_url

- Upload lên cloud storage (AWS S3 / Cloudflare R2)

- Validation:

- Check MIME type (image/jpeg, image/png, image/webp)

- Check file size ≤ 5MB

- Check dimensions: min 500x500px

- Scan virus/malware (optional)

- Chức năng SOFT DELETE & PERMANENT DELETE
- Retention: 30 ngày trong thùng rác, sau đó auto permanent delete (cron job 2AM hàng ngày)
- Không cho xóa nếu: Có đơn hàng PENDING/CONFIRMED/SHIPPING
- Bulk delete: Check từng sản phẩm, skip nếu có đơn hàng, hiển thị kết quả "N/X thành công"
- Permanent delete (thủ công): Confirm 2 lần (lần 2 nhập "DELETE") → Xóa ảnh cloud → Xóa DB → hiện tbao
- Permanent delete (auto): Cron job xóa sản phẩm > 30 ngày, email report admin
- Order history: Khi permanent delete, UPDATE order_items SET product_id=NULL (giữ snapshot name/price)
- AUDIT & METADATA
- Fields cần thêm: created_by, updated_by, deleted_by, created_at, updated_at, deleted_at
- Audit logs table:

CREATE TABLE audit_logs (

id BIGSERIAL PRIMARY KEY,

table_name VARCHAR(50),

record_id BIGINT,

action VARCHAR(20), -- CREATE, UPDATE, DELETE, RESTORE, PERMANENT_DELETE

actor_id BIGINT,

changes JSONB, -- {"old": {...}, "new": {...}}

created_at TIMESTAMP DEFAULT NOW()

);

- Ghi log cho: CREATE, UPDATE, SOFT_DELETE, RESTORE, PERMANENT_DELETE
- UI: Tab "Lịch sử" trong trang chi tiết sản phẩm, hiển thị timeline thao tác

# Attribute