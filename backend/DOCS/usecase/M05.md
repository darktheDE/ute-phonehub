# **USE CASE SPECIFICATION - QUẢN LÝ GIỎ HÀNG**

## **1.1. Thêm sản phẩm vào giỏ hàng**

| **[1]** | **Thêm sản phẩm vào giỏ hàng** |
| --- | --- |
| **Actor** | Registered Customer. |
| **Trigger** | Actor chọn nút **"Thêm vào giỏ hàng"** trên trang sản phẩm. |
| **Description** | Usecase này cho phép Actor thêm sản phẩm điện thoại vào giỏ hàng với số lượng mong muốn. Nếu sản phẩm đã có trong giỏ, hệ thống tự động cộng dồn số lượng. |
| **Pre-Conditions** | Actor đã đăng nhập thành công vào hệ thống. |
| **Post-Conditions** | + Sản phẩm được thêm vào giỏ hàng hoặc số lượng được cập nhật.                                                                             + Tổng tiền giỏ hàng được tính toán lại.                                                                                                                                  + Badge số lượng giỏ hàng trên header tăng lên. |
| **Main Flow** | **1.** Từ trang chi tiết sản phẩm, Actor chọn số lượng muốn mua (mặc định = 1).                                                             **2.** Actor click nút **"Thêm vào giỏ hàng"**.                                                                                                                                **3.** Hệ thống validate JWT token và xác thực người dùng.                                                                                                   **4.** Hệ thống kiểm tra sản phẩm tồn tại trong database và có status = ACTIVE.                                                     **5.** Hệ thống kiểm tra tồn kho: `product.stock_quantity >= requested_quantity`.                                                   **6.** Hệ thống lấy giỏ hàng của Actor:                                                                                                                                                **6.A.** Nếu chưa có Cart → tạo mới với `user_id`.                                                                                                                      **6.B.** Nếu đã có Cart → sử dụng Cart hiện tại.                                                                                                                   **7.** Hệ thống kiểm tra sản phẩm trong giỏ:                                                                                                                                     **7.A.** Nếu đã có → cập nhật `quantity = old_quantity + new_quantity`.                                                                           **7.B.** Nếu chưa có → tạo CartItem mới.                                                                                                                                **8.** Hệ thống lưu thay đổi vào database.                                                                                                                                     **9.** Hệ thống tính toán:                                                                                                                                                                         **9.A.** `subtotal = price × quantity` cho từng item.                                                                                                               **9.B.** `totalAmount = SUM(all subtotals)`.                                                                                                                                 **9.C.** `itemCount = COUNT(cart_items)`.                                                                                                                                 **10.** Hệ thống trả về CartResponse với thông tin cập nhật.                                                                                          **11.** UI hiển thị toast "Đã thêm vào giỏ hàng" và cập nhật badge. |
| **Alternate Flow** | + **3.1.** Nếu Actor chưa đăng nhập, hệ thống chuyển hướng đến trang **Login**. Sau khi login thành công, Actor quay lại trang sản phẩm.                                                                                                                            + **5.1.** Nếu `stock_quantity < requested_quantity`, hệ thống hiển thị thông báo **"Chỉ còn X sản phẩm trong kho"** và disable nút "Thêm vào giỏ".                                                                                                        + **7.A.1.** Nếu `old_quantity + new_quantity > 10`, hệ thống hiển thị **"Chỉ được mua tối đa 10 sản phẩm"** và không thêm.                                                                                                                                                                         + **6.A.1.** Nếu Actor vừa đăng nhập và có guest cart trong localStorage, hệ thống merge items từ guest cart vào user cart, validate tồn kho, xóa guest cart và hiển thị **"Đã đồng bộ X sản phẩm từ giỏ hàng tạm"**. |
| **Exception Flow** | + **4.1.** Nếu sản phẩm không tồn tại hoặc bị xóa, hệ thống trả về 404 Not Found và hiển thị **"Sản phẩm không tồn tại"**.                                                                                                                                                                                  + **8.1.** Nếu database timeout (> 5s), hệ thống trả về 503 Service Unavailable, hiển thị **"Hệ thống đang bận, vui lòng thử lại"** và lưu draft vào localStorage.                                                                                                                        + **8.2.** Nếu database transaction fail (UNIQUE constraint, FK constraint), hệ thống ROLLBACK và trả về 500 với message **"Có lỗi xảy ra, vui lòng thử lại"**.                                                                                                                     + **7.A.2.** Nếu có concurrent update (optimistic locking conflict), hệ thống phát hiện version mismatch, trả về 409 Conflict với state mới nhất, UI reload giỏ hàng và highlight items thay đổi.                                                     + **3.2.** Nếu backend service unavailable, UI retry 3 lần (5s interval). Nếu vẫn fail, lưu request vào IndexedDB và background worker retry mỗi 60s. |

---

## **1.2. Xem giỏ hàng**

| **[2]** | **Xem giỏ hàng** |
| --- | --- |
| **Actor** | Registered Customer. |
| **Trigger** | Actor chọn icon **"Giỏ hàng"** trên header hoặc truy cập `/cart`. |
| **Description** | Usecase này cho phép Actor xem danh sách đầy đủ các sản phẩm trong giỏ hàng, bao gồm hình ảnh, tên, giá, số lượng, thành tiền và tổng tiền. |
| **Pre-Conditions** | Actor đã đăng nhập thành công vào hệ thống. |
| **Post-Conditions** | + Danh sách sản phẩm trong giỏ được hiển thị đầy đủ.                                                                                                      + Trạng thái tồn kho được cập nhật realtime.                                                                                                                          + Tổng tiền được tính toán chính xác. |
| **Main Flow** | **1.** Actor click icon **"Giỏ hàng"** trên header hoặc truy cập `/cart`.                                                                                    **2.** Hệ thống validate JWT token.                                                                                                                                                **3.** Hệ thống thực hiện JOIN query lấy cart + cart_items + products:<br>    `SELECT c.*, ci.*, p.* FROM carts c`    `LEFT JOIN cart_items ci ON c.id = ci.cart_id`    `LEFT JOIN products p ON ci.product_id = p.id`    `WHERE c.user_id = ?`                                                                       ``**4.** Hệ thống kiểm tra tồn kho cho từng sản phẩm:                                                                                                                    **4.A.** Nếu `product.stock = 0` → đánh dấu "Hết hàng".                                                                                                         **4.B.** Nếu `cart_item.quantity > product.stock` → highlight warning.                                                                           **5.** Hệ thống tính toán subtotal và totalAmount.                                                                                                                   **6.** Hệ thống trả về CartResponse.                                                                                                                                           **7.** UI hiển thị:                                                                                                                                                                                       **7.A.** Danh sách sản phẩm với image, name, price, quantity, subtotal.                                                                               **7.B.** Nút +/- để điều chỉnh số lượng.                                                                                                                                          **7.C.** Nút "Xóa" từng sản phẩm.                                                                                                                                                   **7.D.** Tổng tiền tạm tính và nút **"Thanh toán"**. |
| **Alternate Flow** | + **3.1.** Nếu giỏ hàng trống (không có cart_items), hệ thống hiển thị empty state với icon giỏ hàng trống, message **"Giỏ hàng của bạn đang trống"** và button **"Tiếp tục mua sắm"**.                                                         + **4.A.1.** Nếu product không còn tồn tại (bị admin xóa), hệ thống tự động DELETE cart_item đó và hiển thị toast **"1 sản phẩm đã bị xóa khỏi giỏ hàng"**.                                                                                                                  + **5.1.** Nếu giá sản phẩm thay đổi, UI hiển thị badge **"Giá đã thay đổi"** cạnh sản phẩm và tính toán với giá mới nhất. |
| **Exception Flow** | + **3.1.** Nếu database query timeout (> 5s), hệ thống cancel query và trả về 504 Gateway Timeout, UI hiển thị **"Không thể tải giỏ hàng, vui lòng thử lại"** và nút "Retry".                                                                                   + **3.2.** Nếu partial data load (cart_items OK nhưng products NULL), hệ thống filter items có product = NULL, DELETE orphan cart_items và hiển thị **"Một số sản phẩm không còn tồn tại đã bị xóa"**.                                     + **6.1.** Nếu có concurrent view từ nhiều thiết bị với cart version khác nhau, hệ thống trả về cart với `lastModified` timestamp, UI compare với localStorage, hiển thị version mới nhất và subscribe WebSocket để nhận realtime updates. |

---

## **1.3. Cập nhật số lượng sản phẩm**

| **[3]** | **Cập nhật số lượng sản phẩm** |
| --- | --- |
| **Actor** | Registered Customer. |
| **Trigger** | Actor click nút **tăng (+) / giảm (-)** số lượng hoặc nhập số lượng trực tiếp. |
| **Description** | Usecase này cho phép Actor thay đổi số lượng sản phẩm trong giỏ hàng. Nếu số lượng giảm xuống 0, sản phẩm tự động bị xóa. |
| **Pre-Conditions** | Actor đang ở trang giỏ hàng và sản phẩm đã có trong giỏ. |
| **Post-Conditions** | + Số lượng sản phẩm được cập nhật.                                                                                                                                      + Tổng tiền được tính lại.                                                                                                                                                            + Nếu quantity = 0 → sản phẩm bị xóa khỏi giỏ. |
| **Main Flow** | **1.** Actor click nút **(+)** hoặc **(-)** để thay đổi số lượng.                                                                                                       **2.** UI cập nhật số lượng tạm thời (optimistic update).                                                                                                   **3.** UI gửi request: `PUT /api/cart/items/{itemId}` với `{quantity: new_value}`.                                                    **4.** Hệ thống validate JWT token.                                                                                                                                          **5.** Hệ thống kiểm tra quyền sở hữu:                                                                                                                                              |
| **Alternate Flow** | + **6.1.** Nếu `new_quantity > stock_quantity`, hệ thống trả về 400 Bad Request với `availableStock`, UI rollback về số lượng cũ và hiển thị **"Chỉ còn X sản phẩm"**.                                                                                                       + **7.B.1.** Khi Actor giảm quantity xuống 0, hệ thống tự động DELETE cart_item, UI remove item khỏi UI với animation slide-out và hiển thị **"Đã xóa sản phẩm"**.                                                                                                      + **5.1.** Nếu cart_item không thuộc về Actor (query không trả về kết quả), hệ thống trả về 403 Forbidden và UI hiển thị **"Không có quyền thực hiện thao tác này"**.                                                                                                     + **1.1.** Nếu Actor nhập số lượng trực tiếp, UI debounce 500ms sau lần nhập cuối mới gửi request để tránh spam. |
| **Exception Flow** | + **2.1.** Nếu server reject do hết hàng, UI rollback optimistic update về quantity cũ, flash red border trên input và hiển thị error message.                                                                                                                                                    + **7.1.** Nếu có version conflict (concurrent update từ tab/device khác), hệ thống trả về 409 Conflict với `{currentQuantity: 5, requestedQuantity: 3, message: "Giỏ hàng đã được cập nhật từ thiết bị khác"}`, UI reload cart và highlight item với animation blink.                                                                                                     + **7.2.** Nếu database deadlock, hệ thống retry transaction tối đa 3 lần với exponential backoff (100ms, 200ms, 400ms). Sau 3 lần fail → trả về 500 và hiển thị **"Không thể cập nhật, vui lòng thử lại"**.                                          + **3.1.** Nếu network interruption mid-request, request timeout sau 30s, UI hiển thị **"Mất kết nối mạng"**, rollback optimistic update, lưu pending request vào queue và tự động retry khi network restored. |

---

## **1.4. Xóa sản phẩm khỏi giỏ hàng**

| **[4]** | **Xóa sản phẩm khỏi giỏ hàng** |
| --- | --- |
| **Actor** | Registered Customer. |
| **Trigger** | Actor chọn nút **"Xóa"** trên sản phẩm trong giỏ hàng. |
| **Description** | Usecase này cho phép Actor xóa một sản phẩm cụ thể khỏi giỏ hàng. Hệ thống hiển thị confirm dialog trước khi xóa và hỗ trợ undo trong 5 giây. |
| **Pre-Conditions** | Actor đang ở trang giỏ hàng và sản phẩm có trong giỏ. |
| **Post-Conditions** | + Sản phẩm bị xóa khỏi giỏ.                                                                                                                                                       + Tổng tiền được cập nhật.                                                                                                                                                          + itemCount giảm đi 1. |
| **Main Flow** | **1.** Actor click nút **"Xóa"** (icon thùng rác) trên sản phẩm.                                                                                                      **2.** UI hiển thị confirm dialog:                                                                                                                                                          **2.A.** Message: "Bạn có chắc muốn xóa sản phẩm này?"                                                                                                        **2.B.** Button: "Hủy" và "Xóa".                                                                                                                                                      **3.** Actor click **"Xóa"** để xác nhận.                                                                                                                                                **4.** UI gửi request: `DELETE /api/cart/items/{itemId}`.                                                                                                 **5.** Hệ thống validate JWT token.                                                                                                                                                **6.** Hệ thống kiểm tra quyền sở hữu (tương tự UC-3 bước 5).                                                                                       **7.** Hệ thống xóa: `DELETE FROM cart_items WHERE id = ?`.                                                                                                    **8.** Hệ thống tính lại totalAmount và itemCount.                                                                                                                **9.** Hệ thống trả về CartResponse.                                                                                                                                      **10.** UI remove item khỏi danh sách với animation fade-out.                                                                                                **11.** UI hiển thị toast **"Đã xóa sản phẩm"** với nút **"Hoàn tác"** (5s countdown). |
| **Alternate Flow** | + **3.1.** Nếu Actor click **"Hủy"** trong confirm dialog, UI đóng dialog và không có thay đổi nào.                          + **11.1.** Nếu Actor click **"Hoàn tác"** trong 5s, hệ thống thêm lại sản phẩm vào giỏ với số lượng cũ. Nếu trong lúc đó Actor đã thêm lại sản phẩm từ trang product, hệ thống phát hiện duplicate và trả về 409 Conflict với message **"Sản phẩm đã có trong giỏ hàng"**. |
| **Exception Flow** | + **6.1.** Nếu item đã bị xóa bởi tab/device khác (race condition), hệ thống trả về 404 Not Found, UI silent remove item khỏi UI (không hiển thị error vì kết quả mong muốn đã đạt).                                                          + **7.1.** Nếu database CASCADE delete fail do related table bị lock, hệ thống timeout sau 5s, ROLLBACK transaction và trả về 500 với message **"Không thể xóa, vui lòng thử lại sau"**. |

---

## **1.5. Xóa toàn bộ giỏ hàng**

| **[5]** | **Xóa toàn bộ giỏ hàng** |  |
| --- | --- | --- |
| **Actor** | Registered Customer. |  |
| **Trigger** | Actor chọn nút **"Xóa tất cả"** ở header/footer giỏ hàng. |  |
| **Description** | Usecase này cho phép Actor xóa tất cả sản phẩm trong giỏ hàng bằng một thao tác. Do tính nghiêm trọng, yêu cầu nhập "XOA" để xác nhận. |  |
| **Pre-Conditions** | Giỏ hàng có ít nhất 1 sản phẩm. |  |
| **Post-Conditions** | + Tất cả cart_items bị xóa.                                                                                                                                                         + Giỏ hàng trống (totalAmount = 0, itemCount = 0).                                                                                                         + Cart entity vẫn tồn tại (chỉ xóa items). |  |
| **Main Flow** | **1.** Actor click nút **"Xóa tất cả"**.                                                                                                                                            **2.** UI hiển thị confirm dialog nghiêm trọng:                                                                                                                               **2.A.** Warning icon + Message: "Bạn có chắc muốn xóa TOÀN BỘ giỏ hàng?"                                                                 **2.B.** Input field yêu cầu nhập "XOA" (case-insensitive).                                                                                                         **2.C.** Button "Hủy" và "Xóa tất cả" (màu đỏ, disable cho đến khi nhập đúng).                                                     **3.** Actor nhập **"XOA"** để xác nhận.                                                                                                                                **4.** Actor click **"Xóa tất cả".                                                                                                                                                   5.** UI gửi request: `DELETE /api/cart/clear.`                                                          **6.** Hệ thống validate JWT token.                                                                                                                                        **7.** Hệ thống lấy cart của Actor.                                                                                                                                            **8.** Hệ thống xóa tất cả items: `DELETE FROM cart_items WHERE cart_id = ?`.                                                                  **9.** Hệ thống trả về EmptyCartResponse.                                                                                                                          **10.** UI hiển thị empty state.                                                                                                                                                    **11.** UI hiển thị toast **"Đã xóa toàn bộ giỏ hàng"**. |  |
| **Alternate Flow** | + **3.1.** Nếu Actor không nhập hoặc nhập sai "XOA", nút "Xóa tất cả" bị disable và Actor không thể proceed.    + **8.1.** Sau khi đặt hàng thành công (trigger khác từ Order Module), hệ thống tự động clear cart mà không cần confirm (silent delete). |  |
| **Exception Flow** | **+ 8.1.** Nếu Actor có 100+ items (edge case), DELETE query timeout. Hệ thống chuyển sang batch delete:
DELETE FROM cart_items WHERE cart_id = ? LIMIT 50, lặp lại cho đến khi xóa hết.
UI hiển thị progress bar "Đang xóa... 50/100".                                                                                                                       + **8.2.** Nếu có concurrent clear và add (Actor click "Xóa tất cả" trên Desktop, đồng thời admin thêm voucher item vào giỏ từ hệ thống), hệ thống dùng distributed lock (Redis) với TTL 5s để lock cart trước khi clear, đảm bảo không có race condition.                                                                                                                                                   + **8.3.** Nếu có background job đang tạo order_items reference đến cart_items, DELETE vi phạm FK constraint, database ROLLBACK transaction và trả về 409 Conflict với message "Không thể xóa vì có đơn hàng đang xử lý".
UI disable nút "Xóa tất cả" trong 30s. |  |