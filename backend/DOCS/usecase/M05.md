# Tên: Lưu Trần Kim Phú
# MSSV: 23133055 

# USE CASE SPECIFICATION - QUẢN LÝ GIỎ HÀNG

Tài liệu này mô tả các use case nghiệp vụ chính của module Giỏ hàng ở mức hành vi người dùng và phản hồi hệ thống.

---

## 1.1. Thêm sản phẩm vào giỏ hàng

| Thuộc tính | Mô tả |
| --- | --- |
| Mã Use Case | UC-CART-01 |
| Tên Use Case | Thêm sản phẩm vào giỏ hàng |
| Actor | Registered Customer |
| Trigger | Actor chọn nút "Thêm vào giỏ hàng" trên trang chi tiết sản phẩm |
| Mô tả ngắn | Cho phép khách hàng thêm sản phẩm điện thoại vào giỏ hàng. Nếu sản phẩm đã có trong giỏ, hệ thống tự động cộng dồn số lượng. |

### Kết quả sau cùng

- Sản phẩm được thêm vào giỏ hàng hoặc số lượng được cập nhật.
- Tổng tiền giỏ hàng được tính toán lại.
- Badge số lượng giỏ hàng trên header được cập nhật.

### Luồng sự kiện chính

1. Từ trang chi tiết sản phẩm, Actor chọn số lượng muốn mua (mặc định = 1).
2. Actor nhấn nút "Thêm vào giỏ hàng".
3. Đã đăng nhập → xác thực bằng JWT token, Chưa đăng nhập → coi như khách (guest), không xác thực
4. Hệ thống kiểm tra sản phẩm hợp lệ và tồn tại.
5. Hệ thống kiểm tra số lượng tồn kho đáp ứng yêu cầu.
6. Hệ thống lấy giỏ hàng hiện tại của Actor:
	 - Nếu chưa có Cart: tạo mới gắn với `user_id`.
	 - Nếu đã có Cart: sử dụng Cart hiện tại.
7. Hệ thống kiểm tra sản phẩm trong giỏ:
	 - Nếu sản phẩm đã có trong giỏ: cập nhật `số lượng sản phẩm mới = số lượng hiện tại trong giỏ + số lượng yêu cầu` (không vượt quá giới hạn tối đa trên mỗi sản phẩm).
	 - Nếu chưa có: tạo dòng sản phẩm mới với số lượng yêu cầu.
8. Hệ thống lưu thay đổi giỏ hàng.
9. Hệ thống tính toán lại: Tổng tiền cho từng sản phẩm, tổng số lượng sản phẩm (để cập nhật badge), tổng số dòng sản phẩm trong giỏ.
10. Hệ thống trả về phản hồi với thông tin giỏ hàng cập nhật.
11. UI hiển thị thông báo thành công "Đã thêm vào giỏ hàng" và cập nhật badge.

### Luồng phụ (Alternate Flow)

- AF1 – Tồn kho không đủ:
	1. Ở bước 5, nếu số lượng tồn kho không đáp ứng yêu cầu, hệ thống trả về lỗi nghiệp vụ.
	2. UI hiển thị "Chỉ còn X sản phẩm trong kho".

- AF2 – Vượt quá giới hạn tối đa mỗi sản phẩm:
	1. Ở bước 7, nếu "số lượng hiện tại trong giỏ + số lượng yêu cầu" vượt quá giới hạn (ví dụ 10), hệ thống trả về lỗi nghiệp vụ "Chỉ được mua tối đa N sản phẩm" và không thay đổi giỏ.

- AF3 – Merge giỏ hàng tạm sau khi đăng nhập (chức năng REDIS):
	1. Hệ thống nhận danh sách sản phẩm từ giỏ hàng tạm được lưu trữ trên **Redis**.
	2. Với mỗi sản phẩm, kiểm tra tồn kho và giới hạn số lượng.
	3. Chỉ thêm vào giỏ hàng chính các sản phẩm hợp lệ (còn hàng, không vượt quá giới hạn).
	3. Bỏ qua các sản phẩm không hợp lệ (hết hàng, không tồn tại).
	4. Trả về thông báo số lượng sản phẩm đã được hợp nhất thành công vào giỏ hàng người dùng.

### Luồng lỗi (Exception Flow)

- EF1 – Sản phẩm không tồn tại hoặc bị xóa: hệ thống trả về 404 Not Found với thông điệp "Sản phẩm không tồn tại".
- EF2 – Lỗi hệ thống (lỗi database, dịch vụ nội bộ, ...): hệ thống trả về mã lỗi 5xx và thông điệp tổng quát "Có lỗi xảy ra, vui lòng thử lại".
- EF3 – Optimistic locking conflict: nếu giỏ hàng bị cập nhật đồng thời từ phiên khác, hệ thống có thể retry; nếu vẫn không thành công, trả về 409 Conflict kèm trạng thái giỏ mới nhất để UI reload.

---

## 1.2. Xem giỏ hàng

| Thuộc tính | Mô tả |
| --- | --- |
| Mã Use Case | UC-CART-02 |
| Tên Use Case | Xem giỏ hàng |
| Actor | Registered Customer |
| Trigger | Actor chọn icon "Giỏ hàng" trên header hoặc truy cập `/cart` |
| Mô tả ngắn | Cho phép khách hàng xem danh sách đầy đủ các sản phẩm trong giỏ, cùng giá, số lượng, thành tiền và tổng tiền. |

### Kết quả sau cùng

- Danh sách sản phẩm trong giỏ được hiển thị đầy đủ.

### Luồng sự kiện chính

1. Actor truy cập trang `/cart` hoặc click icon "Giỏ hàng" trên header.
2. Đã đăng nhập → xác thực bằng JWT token, Chưa đăng nhập → coi như khách (guest), không xác thực.
3. Hệ thống lấy giỏ hàng và danh sách các dòng sản phẩm tương ứng với user hiện tại (kèm thông tin Product).
4. Hệ thống trả về phản hồi chứa toàn bộ thông tin cần hiển thị (danh sách/số lượng sản phẩm, tổng tiền).
5. Hiển thị thêm nút tăng/giảm số lượng, nút xóa từng sản phẩm, tổng tiền và nút "Thanh toán".

### Luồng phụ (Alternate Flow)

- AF1 – Giỏ hàng trống:
	1. Nếu không có các dòng sản phẩm, hệ thống trả về giỏ rỗng.
	2. UI hiển thị thông điệp "Giỏ hàng của bạn đang trống" và nút "Tiếp tục mua sắm".

### Luồng lỗi (Exception Flow)

- EF1 – Lỗi truy xuất dữ liệu (timeout, lỗi kết nối, ...): hệ thống trả về lỗi 5xx; UI hiển thị thông báo "Không thể tải giỏ hàng, vui lòng thử lại" và cho phép Actor thực hiện lại.
- EF2 – Truy cập đồng thời từ nhiều thiết bị: hệ thống sử dụng optimistic locking hoặc cơ chế realtime (sự kiện CartUpdated, WebSocket, ...) để đảm bảo client luôn có trạng thái mới nhất.
---

## 1.3. Cập nhật số lượng sản phẩm

| Thuộc tính | Mô tả |
| --- | --- |
| Mã Use Case | UC-CART-03 |
| Tên Use Case | Cập nhật số lượng sản phẩm |
| Actor | Registered Customer |
| Trigger | Actor tăng/giảm số lượng |
| Mô tả ngắn | Cho phép khách hàng thay đổi số lượng sản phẩm trong giỏ hàng. Nếu số lượng về 0, sản phẩm sẽ kích hoạt tính năng xóa sản phẩm ở usecase xóa sản phẩm khỏi giỏ. |
| Điều kiện tiên quyết | Actor đang ở trang giỏ hàng và có ít nhất một sản phẩm trong giỏ. |

### Kết quả sau cùng

- Số lượng sản phẩm trong giỏ được cập nhật.
- Tổng tiền của mỗi sản phẩm được tính lại.
- Nếu giảm số lượng bằng 0, sản phẩm thực hiện tính năng xóa sản phẩm khỏi giỏ.

### Luồng sự kiện chính

1. Actor thay đổi số lượng (bằng nút +/− ).
2. UI gửi request PUT /api/v1/cart/items/{itemId}
3. Hệ thống xác thực người dùng (Đã đăng nhập → xác thực bằng JWT token, Chưa đăng nhập → coi như khách (guest), không xác thực.)
4. Hệ thống kiểm tra quyền sở hữu: sản phẩm phải thuộc giỏ hàng của user hiện tại; nếu không, từ chối với lỗi 403.
5. Nếu số lượng cập nhật mới = 0, hệ thống xóa sản phẩm khỏi giỏ.
6. Nếu số lượng cập nhật mới lớn hơn 0, hệ thống tiếp tục kiểm tra; nếu số lượng > 10 sản phẩm, hệ thống sẽ thông báo lỗi.
7. Nếu cập nhật sản phẩm hợp lệ, hệ thống lưu lại số lượng, tính lại tổng tiền của sản phẩm đó.
8. Hệ thống trả về phản hồi mới.
9. UI cập nhật lại giao diện theo dữ liệu mới từ server.

### Luồng phụ (Alternate Flow)

- AF1 – Đưa số lượng về 0:
	1. Khi Actor giảm quantity về 0, hệ thống thực hiện logic xóa item tương tự UC 1.4.
	2. UI loại bỏ item khỏi danh sách sau khi server xác nhận.

- AF2 – vượt giới hạn tối đa 10 sản phẩm:
    1. Nếu số lượng mới lớn hơn giới hạn mua tối đa → trả về lỗi "Chỉ được mua tối đa 10 sản phẩm cho sản phẩm này".
    2. Giao diện khôi phục số lượng cũ, hiển thị thông báo lỗi.
	
- AF3 – Sản phẩm không thuộc về user:
	1. Nếu sản phẩm không thuộc giỏ hàng của user, hệ thống trả về 403 Forbidden với thông điệp phù hợp.

### Luồng lỗi (Exception Flow)

- EF1 – Optimistic locking conflict: nếu giỏ hàng bị cập nhật bởi phiên khác, hệ thống có thể retry; nếu vẫn conflict, trả về 409 cùng trạng thái giỏ mới nhất để UI reload.
- EF2 – Lỗi hệ thống (deadlock, lỗi database, ...): sau khi retry nhiều lần không thành công, hệ thống trả về lỗi 5xx với thông điệp "Không thể cập nhật, vui lòng thử lại".
---

## 1.4. Xóa sản phẩm khỏi giỏ hàng

| Thuộc tính | Mô tả |
| --- | --- |
| Mã Use Case | UC-CART-04 |
| Tên Use Case | Xóa sản phẩm khỏi giỏ hàng |
| Actor | Registered Customer |
| Trigger | Actor chọn nút "Xóa" trên một sản phẩm trong giỏ |
| Mô tả ngắn | Cho phép khách hàng xóa một sản phẩm cụ thể khỏi giỏ hàng. |
| Điều kiện tiên quyết | Actor đang ở trang giỏ hàng và có ít nhất một sản phẩm trong giỏ. |

### Kết quả sau cùng

- Sản phẩm được xóa khỏi giỏ.
- Tổng số lượng sản phẩm được cập nhật lại trên (badge).

### Luồng sự kiện chính

1. Actor click nút "Xóa" (icon thùng rác) trên sản phẩm trong giỏ.
2. UI hiển thị hộp thoại xác nhận với nội dung hỏi lại người dùng.
3. Actor xác nhận xóa.
4. UI gửi request DELETE /api/v1/cart/items/{itemId}.
5. Hệ thống xác thực người dùng (Đã đăng nhập → xác thực bằng JWT token, Chưa đăng nhập → coi như khách (guest), không xác thực.).
6. Hệ thống kiểm tra quyền sở hữu: sản phẩm phải thuộc về giỏ hàng của user hiện tại.
7. Hệ thống xóa sản phẩm tương ứng khỏi giỏ và tính lại tổng số lượng sản phẩm hiển thị trên badge.
8. Hệ thống trả về phản hồi mới.
9. UI đồng thời hiển thị thông báo "Đã xóa sản phẩm".

### Luồng phụ (Alternate Flow)

- AF1 – Người dùng hủy xóa:
	1. Ở bước 2, nếu Actor chọn "Hủy", UI đóng dialog và không gửi request.

- AF2 – Hỗ trợ hoàn tác (undo):
	1. Sau bước 8, UI hiển thị nút "Hoàn tác" trong một khoảng thời gian ngắn.
	2. Nếu Actor chọn "Hoàn tác", UI gửi request thêm lại sản phẩm với số lượng cũ.

### Luồng lỗi (Exception Flow)

- EF1 – sản phẩm đã bị xóa ở nơi khác: khi gọi `DELETE`, nếu sản phẩm không còn tồn tại, hệ thống có thể trả về 404 hoặc coi là thao tác không có tác dụng; UI vẫn loại bỏ item khỏi danh sách và không cần hiển thị lỗi.
- EF2 – Lỗi hệ thống khi xóa (ví dụ do ràng buộc khóa ngoại): hệ thống rollback và trả về lỗi 5xx với thông điệp "Không thể xóa, vui lòng thử lại sau".

---

## 1.5. Xóa toàn bộ giỏ hàng

| Thuộc tính | Mô tả |
| --- | --- |
| Mã Use Case | UC-CART-05 |
| Tên Use Case | Xóa toàn bộ giỏ hàng |
| Actor | Registered Customer |
| Trigger | Actor chọn nút "Xóa tất cả" ở giao diện giỏ hàng |
| Mô tả ngắn | Cho phép khách hàng xóa toàn bộ sản phẩm trong giỏ hàng bằng một thao tác. |
| Điều kiện tiên quyết | Giỏ hàng hiện có ít nhất một sản phẩm. |

### Kết quả sau cùng

- Tất cả sản phẩm trong giỏ bị xóa.
- Giỏ hàng ở trạng thái rỗng.

### Luồng sự kiện chính

1. Actor click nút "Xóa tất cả" trên UI giỏ hàng.
2. UI hiển thị hộp thoại xác nhận với cảnh báo rõ ràng.
3. Actor xác nhận xóa toàn bộ.
4. UI gửi request `DELETE /api/v1/cart/clear`.
5. Hệ thống xác thực người dùng.
6. Hệ thống lấy giỏ hàng tương ứng với user hiện tại.
7. Hệ thống xóa toàn bộ sản phẩm thuộc giỏ hàng đó.
8. Hệ thống trả về phản hồi rỗng.
9. UI hiển thị trạng thái giỏ hàng trống và thông báo "Đã xóa toàn bộ giỏ hàng".

### Luồng phụ (Alternate Flow)

- AF1 – Người dùng không xác nhận xóa: ở bước 2, nếu Actor chọn "Hủy", không có request xóa nào được gửi và giỏ hàng giữ nguyên.
- AF2 – Tự động xóa giỏ sau khi đặt hàng thành công: sau khi Order được tạo thành công ở module Đơn hàng, hệ thống tự động gọi logic clear cart cho user tương ứng mà không yêu cầu xác nhận thêm.

### Luồng lỗi (Exception Flow)

- EF1 – Giỏ rất lớn gây nguy cơ timeout: hệ thống áp dụng cơ chế xóa theo lô (batch) hoặc xử lý phù hợp để tránh khóa hệ thống quá lâu.
- EF2 – Cập nhật đồng thời: nếu có thao tác khác đang thêm sản phẩm trong khi xóa, hệ thống sử dụng cơ chế lock/điều phối ở tầng kỹ thuật (ví dụ: Redis lock) để tránh race condition.
- EF3 – Đang tồn tại tiến trình khác sử dụng CartItem (ví dụ: đang tạo Order): hệ thống có thể từ chối xóa và trả về lỗi nghiệp vụ phù hợp (ví dụ: "Không thể xóa vì có đơn hàng đang xử lý").

---

## 2. Tổng quan API giỏ hàng (tóm tắt)

Các endpoint chính:

- `GET /api/v1/cart/me`
	- Lấy giỏ hàng hiện tại của user.
	- Yêu cầu: Bearer token hợp lệ.
	- Response: `ApiResponse<CartResponse>`.

- `POST /api/v1/cart/items`
	- Thêm sản phẩm vào giỏ hoặc cộng dồn số lượng.
	- Body: `{ productId: Long, quantity: number (1–10) }`.
	- Response: `ApiResponse<CartResponse>`.

- `PUT /api/v1/cart/items/{itemId}`
	- Cập nhật số lượng một item trong giỏ.
	- Body: `{ quantity: number (0–10) }`.
	- Response: `ApiResponse<CartResponse>`.

- `DELETE /api/v1/cart/items/{itemId}`
	- Xóa một item khỏi giỏ.
	- Response: `ApiResponse<CartResponse>`.

- `DELETE /api/v1/cart/clear`
	- Xóa toàn bộ sản phẩm trong giỏ của user hiện tại.
	- Response: `ApiResponse<CartResponse>` (giỏ rỗng).

- `POST /api/v1/cart/merge`
	- Merge guest cart (giỏ tạm trên client) vào giỏ hàng của user sau khi đăng nhập.
	- Body: danh sách item tạm thời từ client.
	- Response: `ApiResponse<MergeCartResponse>` (bao gồm cart sau khi merge và số lượng item được merge/bỏ qua).

---

